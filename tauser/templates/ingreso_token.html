{% extends 'llave_billetes.html' %}
{% load static %}
{% load formato_numeros %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'claro/formularios.css' %}" media="(prefers-color-scheme: light)">
    <link rel="stylesheet" href="{% static 'oscuro/formularios.css' %}" media="(prefers-color-scheme: dark)">
{% endblock %}

{% block content %}
<div class="contenido">
    <div class="form-cabecera">
        <div class="logo">Tauser - Global Exchange</div>
        <p class="subtitulo">Ingresa el token de transacción</p>
    </div>
    
    <form method="post" novalidate>
        {% csrf_token %}
        <div class="form-campo">
            {{ form.codigo }}
            {% if form.codigo.errors %}
                <div class="form-errores">
                    {% for error in form.codigo.errors %}
                        <div class="mensaje-error">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="zona-botones">
            <button type="submit" name="accion" value="enviar" class="btn-enviar">
                Enviar código
            </button>
            <a href="{% url 'inicio' %}" class="btn-atras">
                Volver al Inicio
            </a>
        </div>
    </form>
    {% if cambios %}
    <div class="popup-overlay" style="display: flex">
        <div class="popup-contenido" style="max-width: 700px;">
            <div class="popup-cabecera">
                <h3>¡La cotización ha cambiado!</h3>
            </div>
            <div class="popup-cuerpo">
                {% if transaccion.tipo == 'compra' %}
                    <p>El precio de venta a cambiado de Gs. {{ cambios.valores_anteriores.precio_venta|formateado }} a Gs. {{ cambios.valores_actuales.precio_venta|formateado }}</p>
                {% else %}
                    <p>El precio de compra a cambiado de Gs. {{ cambios.valores_anteriores.precio_compra|formateado }} a Gs. {{ cambios.valores_actuales.precio_compra|formateado }}</p>
                {% endif %}
                
                {% if cambios.email_enviado %}
                    <div class="mensaje-info" style="margin: 1rem 0; padding: 1rem; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 5px; color: #0c5460;">
                        <strong>📧 Notificación enviada:</strong> Se ha enviado un correo electrónico a <strong>{{ email_usuario }}</strong> con los detalles del cambio de cotización para tu referencia.
                    </div>
                {% elif email_usuario %}
                    <div class="mensaje-advertencia" style="margin: 1rem 0; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
                        <strong>⚠️ Notificación no enviada:</strong> Hubo un problema al enviar la notificación por correo electrónico, pero puedes continuar con la transacción.
                    </div>
                {% else %}
                    <div class="mensaje-advertencia" style="margin: 1rem 0; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
                        <strong>📧 Sin email:</strong> No se proporcionó un email para recibir notificaciones de cambios de cotización.
                    </div>
                {% endif %}
                
                <form method="post">
                {% csrf_token %}
                    <div class="zona-botones">
                        <button type="submit" name="accion" value="aceptar" class="btn-enviar">
                            Aceptar Nuevo Precio
                        </button>
                        <button type="submit" name="accion" value="cancelar" class="btn-atras">
                            Cancelar Operación
                        </button>
                    </div>
                </form>    
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}