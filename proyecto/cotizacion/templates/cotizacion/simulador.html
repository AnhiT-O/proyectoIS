{% extends 'base.html' %}
{% load static %}

{% block title %}Simulador de Conversiones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'formularios.css' %}">
<link rel="stylesheet" href="{% static 'simulador.css' %}">
{% endblock %}

{% block content %}
<div class="cuerpo">
    <div class="contenido">
        <div class="form-cabecera">
            <div class="logo">Simulador de Conversiones</div>
            <p class="subtitulo">Calcule el cambio de monedas en tiempo real</p>
        </div>
        
        <form id="simulador-form" method="post">
            {% csrf_token %}
            
            <div class="form-campo">
                <div class="tipo-operacion">
                    <button type="button" class="btn-primario activo" data-operacion="compra">Compra</button>
                    <button type="button" class="btn-secundario" data-operacion="venta">Venta</button>
                </div>
            </div>

            <div class="form-campo">
                <label for="moneda">Seleccione la moneda:</label>
                <select id="moneda" name="moneda" class="form-control" required>
                    <option value="">Seleccione una moneda</option>
                    {% for moneda in monedas %}
                        {% if moneda.simbolo != 'PYG' %}
                            <option value="{{ moneda.id }}" data-simbolo="{{ moneda.simbolo }}">
                                {{ moneda.simbolo }} - {{ moneda.nombre }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="form-campo">
                <label for="monto">Monto:</label>
                <input type="number" 
                       id="monto" 
                       name="monto" 
                       class="form-control" 
                       step="0.01" 
                       min="0.01" 
                       placeholder="Ingrese el monto en guaraníes" 
                       required>
            </div>

            <div class="form-campo">
                <label for="resultado">Resultado:</label>
                <input type="text" 
                       id="resultado" 
                       class="form-control" 
                       readonly>
            </div>

            <div class="zona-botones">
                <button type="submit" class="btn-enviar">Convertir</button>
                <a href="{% url 'inicio' %}" class="btn-atras">Volver</a>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('simulador-form');
    const btnCompra = document.querySelector('[data-operacion="compra"]');
    const btnVenta = document.querySelector('[data-operacion="venta"]');
    const montoInput = document.getElementById('monto');
    const resultadoInput = document.getElementById('resultado');
    let tipoOperacion = 'compra';

    // Manejador de botones de operación
    function toggleOperacion(btn) {
        // Restaurar estilos por defecto
        if (btn === btnCompra) {
            btnCompra.classList.remove('btn-secundario');
            btnCompra.classList.add('btn-primario', 'activo');
            btnVenta.classList.remove('btn-primario', 'activo');
            btnVenta.classList.add('btn-secundario');
        } else {
            btnVenta.classList.remove('btn-secundario');
            btnVenta.classList.add('btn-primario', 'activo');
            btnCompra.classList.remove('btn-primario', 'activo');
            btnCompra.classList.add('btn-secundario');
        }
        tipoOperacion = btn.dataset.operacion;
        
        // Actualizar placeholder según operación
        montoInput.placeholder = tipoOperacion === 'compra' 
            ? 'Ingrese el monto en guaraníes (PYG)'
            : 'Ingrese el monto en la moneda extranjera';
            
        // Limpiar campos
        montoInput.value = '';
        resultadoInput.value = '';
    }

    btnCompra.addEventListener('click', () => toggleOperacion(btnCompra));
    btnVenta.addEventListener('click', () => toggleOperacion(btnVenta));

    // Manejar envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        formData.append('operacion', tipoOperacion);

        fetch('{% url "cotizacion:simular_conversion" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultadoInput.value = data.resultado;
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al procesar la conversión');
        });
    });
});

function resetForm() {
    const form = document.getElementById('simulador-form');
    const btnCompra = document.querySelector('[data-operacion="compra"]');
    form.reset();
    toggleOperacion(btnCompra);
}
</script>
{% endblock %}
{% endblock %}
