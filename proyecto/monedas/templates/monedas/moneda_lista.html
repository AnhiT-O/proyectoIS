{% extends 'base.html' %}
{% load static %}

{% block title %}Gestionar Monedas - Global Exchange{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gestion.css' %}">
<style>
    .no-monedas {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .no-monedas-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }

    .no-monedas h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #495057;
    }

    .no-monedas p {
        font-size: 1.1rem;
        margin-bottom: 2rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.5;
    }

</style>
{% endblock %}

{% block content %}
<div class="contenido">
    <div class="gestion-cabecera">
        <h2>Gestionar Monedas</h2>
        {% if perms.monedas.gestion %}
        <a href="{% url 'monedas:crear_monedas' %}" class="btn-primario">
            Nueva Moneda
        </a>
        {% endif %}
    </div>
    <!-- Formulario de b칰squeda con nuevo estilo -->
    <div class="zona-busqueda">
        <form method="get" class="busqueda-form">
            <div class="campo-busqueda">
                <input type="text" 
                        name="busqueda" 
                        class="texto-busqueda" 
                        value="{{ busqueda }}" 
                        placeholder="Buscar moneda por nombre o s칤mbolo...">
            </div>
            <div class="botones-busqueda">
                <button type="submit" class="btn-buscar">
                    Buscar
                </button>
                {% if busqueda %}
                <a href="{% url 'monedas:lista_monedas' %}" class="btn-limpiar">
                    Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="zona-conteo">
        <div class="conteo-info">
            <span>Total: <span class="conteo">{{ monedas|length }}</span></span>
            <span style="margin-left: 1rem;">Activas: <span class="conteo" style="background: #28a745;">{{ monedas_activas }}</span></span>
            <span style="margin-left: 0.5rem;">Inactivas: <span class="conteo" style="background: #dc3545;">{{ monedas_inactivas }}</span></span>
        </div>
    </div>

    <div class="zona-monedas" id="monedasGrid">
        {% for moneda in monedas %}
        <div class="tarjeta-moneda" data-search="{{ moneda.nombre|lower }} {{ moneda.simbolo|lower }}">
            <!-- Cabecera comprimida: nombre a la izquierda, s칤mbolo a la derecha -->
            <div class="tarjeta-cabecera">
                <h3>{{ moneda.nombre }}</h3>
                <div class="moneda-simbolo">{{ moneda.simbolo }}</div>
            </div>
            <!-- Informaci칩n tipo tabla -->
            <table class="gestion-tabla" style="word-break: inherit">
                <thead>
                    <tr>
                        <th style="width: 80px">Estado</th>
                        <th style="width: 90px">Decimales a mostrar</th>
                        <th style="width: 120px">Tasa base</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="{% if moneda.activa %}etiqueta-activo{% else %}etiqueta-inactivo{% endif %}" style="font-size:0.95rem; display:inline-block; margin-top:0;">
                                {% if moneda.activa %}Activa{% else %}Inactiva{% endif %}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-size:1rem; color:#333; font-weight:700;">{{ moneda.decimales }}</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-size:1rem; color:#333; font-weight:700;">{{ moneda.tasa_base }}</span>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="zona-acciones" style="justify-content: flex-end">
                {% if perms.monedas.gestion or perms.monedas.cambiar_tasa or perms.monedas.cambiar_decimales %}
                <a href="{% url 'monedas:editar_monedas' moneda.pk %}" class="btn-editar" title="Editar moneda">
                    Editar
                </a>
                {% endif %}
                {% if perms.monedas.activacion %}
                    {% if moneda.activa %}
                        <form method="post" action="{% url 'monedas:lista_monedas' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="cambiar_estado" value="true">
                            <input type="hidden" name="moneda_id" value="{{ moneda.pk }}">
                            <button type="submit" class="btn-desactivar" title="Desactivar moneda" onclick="return confirm('쮼st치s seguro de que quieres desactivar la moneda {{ moneda.nombre }}?')">
                                Desactivar
                            </button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'monedas:lista_monedas' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="cambiar_estado" value="true">
                            <input type="hidden" name="moneda_id" value="{{ moneda.pk }}">
                            <button type="submit" class="btn-activar" title="Activar moneda" onclick="return confirm('쮼st치s seguro de que quieres activar la moneda {{ moneda.nombre }}?')">
                                Activar
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% empty %}
            {% if busqueda %}
                <div class="no-monedas">
                    <div class="no-monedas-icon">游댌</div>
                    <h3>No se encontraron monedas</h3>
                </div>
            {% else %}
                <div class="no-monedas">
                    <div class="no-monedas-icon">游눯</div>
                    <h3>No hay monedas registradas</h3>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <!-- Distinguir entre no hay monedas en el sistema vs no se encontraron resultados -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const grid = document.getElementById('monedasGrid');
    
    if (searchInput && grid) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const cards = grid.getElementsByClassName('moneda-card');
            
            // Primero aplicamos la b칰squeda a todas las cartas
            for (let card of cards) {
                const searchData = card.getAttribute('data-search');
                if (searchData.includes(searchTerm)) {
                    card.setAttribute('data-search-visible', 'true');
                } else {
                    card.setAttribute('data-search-visible', 'false');
                }
            }
            
            // Luego aplicamos tanto el filtro actual como la b칰squeda
            aplicarFiltrosYBusqueda();
        });
    }
});

function aplicarFiltrosYBusqueda() {
    const cards = document.getElementsByClassName('moneda-card');
    const activeFilterBtn = document.querySelector('.filter-btn.active');
    let currentFilter = 'todas';
    
    if (activeFilterBtn) {
        if (activeFilterBtn.id === 'btn-activas') currentFilter = 'activas';
        else if (activeFilterBtn.id === 'btn-inactivas') currentFilter = 'inactivas';
    }
    
    for (let card of cards) {
        const searchVisible = card.getAttribute('data-search-visible') !== 'false';
        let filterVisible = true;
        
        // Aplicar filtro por estado
        switch (currentFilter) {
            case 'activas':
                filterVisible = !card.classList.contains('inactiva');
                break;
            case 'inactivas':
                filterVisible = card.classList.contains('inactiva');
                break;
            case 'todas':
            default:
                filterVisible = true;
                break;
        }
        
        // Mostrar solo si coincide tanto con b칰squeda como con filtro
        if (searchVisible && filterVisible) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    }
}

function filtrarMonedas(tipo) {
    const btnTodas = document.getElementById('btn-todas');
    const btnActivas = document.getElementById('btn-activas');
    const btnInactivas = document.getElementById('btn-inactivas');
    
    // Remover clase active de todos los botones
    [btnTodas, btnActivas, btnInactivas].forEach(btn => {
        if (btn) btn.classList.remove('active');
    });
    
    // Agregar clase active al bot칩n correspondiente
    if (tipo === 'todas' && btnTodas) btnTodas.classList.add('active');
    else if (tipo === 'activas' && btnActivas) btnActivas.classList.add('active');
    else if (tipo === 'inactivas' && btnInactivas) btnInactivas.classList.add('active');
    
    // Aplicar filtros y b칰squeda
    aplicarFiltrosYBusqueda();
}
</script>
{% endblock %}
