<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Global Exchange{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'global.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Barra de navegación -->
    {% block navbar %}
    <nav class="zona-barra">
        <div class="barra-contenido">
            <a href="{% url 'inicio' %}" class="barra-logo">
                💰 Global Exchange
            </a>
            
            <div class="barra-navegacion">
                {% if user.is_authenticated %}
                    <div class="zona-usuario">
                        <span class="usuario-nombre">Hola, {{ user.first_name }}!</span>

                        <!-- Panel de Administración basado en permisos -->
                        {% if perms.usuarios or perms.clientes or perms.roles or perms.monedas %}
                            <div class="panel-gestiones">
                                <a href="#" class="btn-admin" onclick="toggleAdminMenu(event)">
                                    ⚙️ Panel de Gestiones
                                </a>
                                <div class="gestion-menu" id="adminMenu">
                                    <!-- Gestión de Usuarios -->
                                    {% if perms.usuarios %}
                                        <a href="{% url 'usuarios:administrar_usuarios' %}" class="gestion-seleccion">
                                            👥 Gestionar Usuarios
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Gestión de Roles -->
                                    {% if perms.roles %}
                                        <a href="{% url 'roles:listar_roles' %}" class="gestion-seleccion">
                                            🎭 Gestionar Roles
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Gestión de Clientes -->
                                    {% if perms.clientes %}
                                        <a href="{% url 'clientes:cliente_lista' %}" class="gestion-seleccion">
                                            👥 Gestionar Clientes
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Gestión de Monedas -->
                                    {% if perms.monedas %}
                                        <a href="{% url 'monedas:lista_monedas' %}" class="gestion-seleccion">
                                            💱 Gestionar Monedas
                                        </a>
                                    {% endif %}

                                    <!-- Gestión de Cotizaciones -->
                                    {% if perms.clientes %}
                                        <a href="{% url 'cotizacion:cotizacion_lista' %}" class="gestion-seleccion">
                                            💹 Gestionar Cotizaciones
                                        </a>
                                    {% endif %}

                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Mostrar Ver Clientes solo si el usuario tiene clientes asociados -->
                        {% if user.clientes_operados.exists %}
                            <a href="{% url 'usuarios:mis_clientes' %}" class="btn-admin">
                                👥 Ver Clientes
                            </a>
                        {% endif %}
                        
                        <a href="{% url 'usuarios:perfil' %}" class="btn-secundario">
                            👤 Mi Perfil
                        </a>
                        <a href="{% url 'logout' %}" class="btn-primario">
                             Cerrar Sesión
                        </a>
                    </div>
                {% else %}
                    <a href="{% url 'login' %}" class="btn-secundario">
                        Iniciar Sesión
                    </a>
                    <a href="{% url 'usuarios:registro' %}" class="btn-primario">
                        Registrarse
                    </a>
                {% endif %}
            </div>
        </div>
    </nav>
    {% endblock %}

    <!-- Mensajes del sistema -->
    {% if messages %}
        <div class="zona-alertas">
            {% for message in messages %}
                <div class="alerta alerta-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Contenido principal -->
    <main class="cuerpo">
        {% block content %}{% endblock %}
    </main>

    {% block extra_js %}{% endblock %}
    
    <!-- JavaScript personalizado para el dropdown del panel de administración -->
    <script>
        function toggleAdminMenu(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = document.getElementById('adminMenu');
            menu.classList.toggle('show');
        }

        // Cerrar el menú al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const panelGestiones = document.querySelector('.panel-gestiones');
            const menu = document.getElementById('adminMenu');
            
            if (panelGestiones && menu && !panelGestiones.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // Cerrar el menú al presionar Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('adminMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>