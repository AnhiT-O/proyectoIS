

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transacciones.views &mdash; documentación de Global Exchange - Versión 2</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=3e28a9e4"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=f85f4cfb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Global Exchange
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../clientes.html">Clientes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usuarios.html">Usuarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roles.html">Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monedas.html">Monedas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transacciones.html">Transacciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../medios_acreditacion.html">Medios de Acreditación</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../proyecto.html">Directorio principal del Proyecto</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Global Exchange</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Código de módulo</a></li>
      <li class="breadcrumb-item active">transacciones.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Código fuente para transacciones.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Vistas para el sistema de transacciones de Global Exchange.</span>

<span class="sd">Este módulo contiene todas las vistas necesarias para el procesamiento de transacciones</span>
<span class="sd">de compra y venta de monedas extranjeras, incluyendo la gestión del flujo completo</span>
<span class="sd">desde la selección inicial hasta la confirmación final.</span>

<span class="sd">Funcionalidades principales:</span>
<span class="sd">    - Proceso completo de compra de monedas (4 pasos)</span>
<span class="sd">    - Proceso completo de venta de monedas (4 pasos)</span>
<span class="sd">    - Gestión de recargos por medio de pago</span>
<span class="sd">    - Historial y consulta de transacciones</span>
<span class="sd">    - Validaciones de límites en tiempo real</span>
<span class="sd">    - Generación y gestión de tokens de seguridad</span>

<span class="sd">Author: Equipo de desarrollo Global Exchange</span>
<span class="sd">Date: 2025</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">permission_required</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monedas.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Moneda</span><span class="p">,</span> <span class="n">StockGuaranies</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">medios_acreditacion.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">TarjetaLocal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">SeleccionMonedaMontoForm</span><span class="p">,</span> <span class="n">VariablesForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transaccion</span><span class="p">,</span> <span class="n">Recargos</span><span class="p">,</span> <span class="n">LimiteGlobal</span><span class="p">,</span> <span class="n">Tauser</span><span class="p">,</span> <span class="n">calcular_conversion</span><span class="p">,</span> <span class="n">procesar_pago_stripe</span><span class="p">,</span> <span class="n">procesar_transaccion</span><span class="p">,</span> <span class="n">verificar_cambio_cotizacion_sesion</span><span class="p">,</span> <span class="n">generar_token_transaccion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils_2fa</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_2fa_enabled</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clientes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cliente</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stripe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stripe</span>

<span class="c1"># Importaciones para exportación de archivos (se importan en las funciones para manejo de errores)</span>
<span class="c1"># from reportlab.pdfgen import canvas</span>
<span class="c1"># from reportlab.lib.pagesizes import letter, A4</span>
<span class="c1"># from reportlab.lib.styles import getSampleStyleSheet</span>
<span class="c1"># from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer</span>
<span class="c1"># from reportlab.lib import colors</span>
<span class="c1"># from reportlab.lib.units import inch</span>
<span class="c1"># import openpyxl</span>
<span class="c1"># from openpyxl.styles import Font, PatternFill, Alignment, Border, Side</span>
<span class="c1"># from io import BytesIO</span>

<span class="c1"># Configurar Stripe</span>
<span class="n">stripe</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># PROCESO DE COMPRA DE MONEDAS</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="compra_monto_moneda">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.compra_monto_moneda">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compra_monto_moneda</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Primer paso del proceso de compra: selección de moneda y monto.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar la moneda extranjera que desea comprar</span>
<span class="sd">    y especificar el monto. Incluye validaciones de límites de transacción</span>
<span class="sd">    antes de proceder al siguiente paso.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Usuario debe tener un cliente activo</span>
<span class="sd">        - Monto debe cumplir con límites diarios y mensuales</span>
<span class="sd">        - Moneda debe estar activa en el sistema</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con datos del formulario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_moneda_monto.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - form: Formulario de selección de moneda y monto</span>
<span class="sd">        - paso_actual: Número del paso actual (1)</span>
<span class="sd">        - total_pasos: Total de pasos en el proceso (4)</span>
<span class="sd">        - titulo_paso: Título descriptivo del paso</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;compra&#39;)</span>
<span class="sd">        - limites_disponibles: Información de límites del cliente</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transacciones_pasadas</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Expira el tiempo para confirmar la transacción&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario sale del proceso de compra&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SeleccionMonedaMontoForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">moneda</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">]</span>
            <span class="n">monto</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;monto_decimal&#39;</span><span class="p">]</span>
            <span class="n">cliente_activo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span>
            
            <span class="c1"># Si pasa las validaciones, guardar los datos en la sesión</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">monto</span><span class="p">),</span>  <span class="c1"># Convertir Decimal a string para serialización</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
            <span class="c1"># Guardar precios iniciales en la sesión</span>
            <span class="n">precios</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">get_precios_cliente</span><span class="p">(</span><span class="n">cliente_activo</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_venta_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precios</span><span class="p">[</span><span class="s1">&#39;precio_venta&#39;</span><span class="p">]</span>
            <span class="c1"># Redireccionar al siguiente paso sin parámetros en la URL</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_pago&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Verificar si el usuario tiene un cliente activo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debes tener un cliente activo para realizar compras.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span> <span class="o">!=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span><span class="o">.</span><span class="n">month</span> <span class="o">!=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Si cliente_activo.ultimo_consumo es None, no hacemos nada y los consumos</span>
        <span class="c1"># se mantienen en 0 (que es el valor inicial/correcto para un nuevo día/mes).</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SeleccionMonedaMontoForm</span><span class="p">()</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;disponible_diario&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_diario</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span><span class="p">),</span>
        <span class="s1">&#39;disponible_mensual&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_mensual</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span><span class="p">),</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Moneda y Monto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;compra&#39;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_moneda_monto.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="compra_medio_pago">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.compra_medio_pago">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compra_medio_pago</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segundo paso del proceso de compra: selección del medio de pago.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar cómo va a pagar por la moneda extranjera.</span>
<span class="sd">    Las opciones incluyen efectivo, billetera electrónica, transferencia</span>
<span class="sd">    bancaria y tarjetas de crédito registradas en Stripe.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Datos del paso anterior deben existir en sesión</span>
<span class="sd">        - Usuario debe tener cliente activo</span>
<span class="sd">        - Medio de pago debe estar disponible para el cliente</span>
<span class="sd">        - Verificación de cambios en cotización</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con selección de medio de pago</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_medio_pago.html o transacciones/cotizacion_cambiada.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda seleccionada en el paso anterior</span>
<span class="sd">        - monto: Monto seleccionado en el paso anterior</span>
<span class="sd">        - medios_pago: Lista de medios de pago disponibles</span>
<span class="sd">        - medio_pago_seleccionado: Medio actualmente seleccionado</span>
<span class="sd">        - cliente_activo: Cliente activo del usuario</span>
<span class="sd">        - paso_actual: Número del paso actual (2)</span>
<span class="sd">        - total_pasos: Total de pasos en el proceso (4)</span>
<span class="sd">        - titulo_paso: Título descriptivo del paso</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;compra&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">compra_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span> <span class="ow">or</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el primer paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="c1"># Recuperar los datos de la sesión</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
        <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Verificar si es selección de medio de pago o avance al siguiente paso</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;seleccionar_medio&#39;</span><span class="p">:</span>
            <span class="c1"># Manejar la selección de medio de pago</span>
            <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medio_pago</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Actualizar los datos de la sesión (sin cambiar el paso_actual)</span>
                    <span class="n">compra_datos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;medio_pago&#39;</span><span class="p">:</span> <span class="n">medio_pago</span>
                    <span class="p">})</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compra_datos</span>
                    <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                        <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de pago Tarjeta de Crédito (**** **** **** </span><span class="si">{</span><span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;last4&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">) seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de pago </span><span class="si">{</span><span class="n">medio_pago</span><span class="si">}</span><span class="s1"> seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_pago&#39;</span><span class="p">)</span>  <span class="c1"># Permanecer en el mismo paso</span>
        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al seleccionar el medio de pago. Intente nuevamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_pago&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;continuar&#39;</span><span class="p">:</span>
            <span class="c1"># Verificar que hay un medio de pago seleccionado</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe seleccionar un medio de pago antes de continuar.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_pago&#39;</span><span class="p">)</span>
            
            <span class="c1"># Actualizar el paso actual y continuar al siguiente paso</span>
            <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compra_datos</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
    
    <span class="n">medios_pago_disponibles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Efectivo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Transferencia Bancaria&#39;</span>
    <span class="p">]</span>
    <span class="c1"># Agregar billeteras electrónicas como medio de pago si hay recargos configurados</span>
    <span class="n">recargos_billetera</span> <span class="o">=</span> <span class="n">Recargos</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">medio</span><span class="o">=</span><span class="s1">&#39;Billetera Electrónica&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">recargo</span> <span class="ow">in</span> <span class="n">recargos_billetera</span><span class="p">:</span>
        <span class="n">medios_pago_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recargo</span><span class="o">.</span><span class="n">marca</span><span class="p">)</span>
    <span class="c1"># Verificar si el cliente tiene tarjetas de crédito activas en Stripe</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">tiene_tarjetas_activas</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tarjeta</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">obtener_tarjetas_stripe</span><span class="p">():</span>
            <span class="n">medios_pago_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarjeta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">TarjetaLocal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span> <span class="n">activo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tarjeta</span> <span class="ow">in</span> <span class="n">TarjetaLocal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span> <span class="n">activo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">dict_tarjeta</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tarjeta</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;brand&quot;</span><span class="p">:</span> <span class="n">tarjeta</span><span class="o">.</span><span class="n">brand</span><span class="p">,</span>
                <span class="s2">&quot;last4&quot;</span><span class="p">:</span> <span class="n">tarjeta</span><span class="o">.</span><span class="n">last4</span>
            <span class="p">}</span>
            <span class="n">medios_pago_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dict_tarjeta</span><span class="p">)</span>
    <span class="c1"># Obtener el medio de pago seleccionado actualmente (si hay uno)</span>
    <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
            <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
        <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
        <span class="s1">&#39;medios_pago&#39;</span><span class="p">:</span> <span class="n">medios_pago_disponibles</span><span class="p">,</span>
        <span class="s1">&#39;medio_pago_seleccionado&#39;</span><span class="p">:</span> <span class="n">medio_pago_seleccionado</span><span class="p">,</span>
        <span class="s1">&#39;cliente_activo&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Medio de Pago&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;compra&#39;</span>  <span class="c1"># Agregar contexto para diferenciar en plantilla</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_medio_pago.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="compra_medio_cobro">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.compra_medio_cobro">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compra_medio_cobro</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tercer paso del proceso de compra: selección del medio de cobro.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar cómo va a recibir la moneda extranjera</span>
<span class="sd">    que está comprando. Actualmente solo se ofrece la opción de efectivo</span>
<span class="sd">    como medio de cobro para las compras.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Datos de pasos anteriores deben existir en sesión</span>
<span class="sd">        - Usuario debe tener cliente activo</span>
<span class="sd">        - Medio de cobro debe estar disponible</span>
<span class="sd">        - Verificación de cambios en cotización</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con selección de medio de cobro</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_medio_cobro.html o transacciones/cotizacion_cambiada.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda seleccionada</span>
<span class="sd">        - monto: Monto seleccionado</span>
<span class="sd">        - medio_pago: Medio de pago seleccionado</span>
<span class="sd">        - medios_cobro: Lista de medios de cobro disponibles</span>
<span class="sd">        - medio_cobro_seleccionado: Medio de cobro actualmente seleccionado</span>
<span class="sd">        - cliente_activo: Cliente activo del usuario</span>
<span class="sd">        - paso_actual: Número del paso actual (3)</span>
<span class="sd">        - total_pasos: Total de pasos en el proceso (4)</span>
<span class="sd">        - titulo_paso: Título descriptivo del paso</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;compra&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">compra_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span> <span class="ow">or</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el segundo paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_pago&#39;</span><span class="p">)</span>
    
    <span class="c1"># Recuperar los datos de la sesión</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
        <span class="c1"># Guardar valores iniciales de cotización</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;tasa_base_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">tasa_base</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;comision_compra_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">comision_compra</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;comision_venta_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">comision_venta</span>
        <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
        <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Verificar si es selección de medio de cobro o avance al siguiente paso</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;seleccionar_medio&#39;</span><span class="p">:</span>
            <span class="c1"># Manejar la selección de medio de cobro</span>
            <span class="n">medio_cobro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medio_cobro</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Actualizar los datos de la sesión (sin cambiar el paso_actual)</span>
                    <span class="n">compra_datos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;medio_cobro&#39;</span><span class="p">:</span> <span class="n">medio_cobro</span>
                    <span class="p">})</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compra_datos</span>

                    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de cobro </span><span class="si">{</span><span class="n">medio_cobro</span><span class="si">}</span><span class="s1"> seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>  <span class="c1"># Permanecer en el mismo paso</span>
        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al seleccionar el medio de cobro. Intente nuevamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;continuar&#39;</span><span class="p">:</span>
            <span class="c1"># Verificar que hay un medio de cobro seleccionado</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe seleccionar un medio de cobro antes de continuar.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
            
            <span class="c1"># Actualizar el paso actual y continuar al siguiente paso</span>
            <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compra_datos</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_confirmacion&#39;</span><span class="p">)</span>
    
    <span class="c1"># Construir lista de medios de cobro disponibles</span>
    <span class="n">medios_cobro_disponibles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Efectivo&#39;</span><span class="p">]</span>  <span class="c1"># Opción fija</span>

    <span class="c1"># Obtener el medio de cobro seleccionado actualmente (si hay uno)</span>
    <span class="n">medio_cobro_seleccionado</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">):</span>
        <span class="n">medio_cobro_seleccionado</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
        <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
        <span class="s1">&#39;medio_pago&#39;</span><span class="p">:</span> <span class="n">medio_pago</span><span class="p">,</span>
        <span class="s1">&#39;medios_cobro&#39;</span><span class="p">:</span> <span class="n">medios_cobro_disponibles</span><span class="p">,</span>
        <span class="s1">&#39;medio_cobro_seleccionado&#39;</span><span class="p">:</span> <span class="n">medio_cobro_seleccionado</span><span class="p">,</span>
        <span class="s1">&#39;cliente_activo&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Medio de Cobro&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;compra&#39;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_medio_cobro.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="compra_confirmacion">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.compra_confirmacion">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compra_confirmacion</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cuarto paso del proceso de compra: confirmación y creación de transacción.</span>
<span class="sd">    </span>
<span class="sd">    Muestra un resumen completo de la transacción y procede a crearla en</span>
<span class="sd">    la base de datos. Para medios de pago como Efectivo o Transferencia,</span>
<span class="sd">    genera un token de seguridad con validez de 5 minutos.</span>
<span class="sd">    </span>
<span class="sd">    Acciones realizadas:</span>
<span class="sd">        - Verificación de cambios en cotización</span>
<span class="sd">        - Creación de registro de transacción en base de datos</span>
<span class="sd">        - Generación de token para medios específicos</span>
<span class="sd">        - Configuración del estado inicial como &#39;Pendiente&#39;</span>
<span class="sd">        - Vinculación con cliente y usuario activos</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP de confirmación</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza página de confirmación o modal de cambio</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/confirmacion.html o transacciones/cotizacion_cambiada.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda de la transacción</span>
<span class="sd">        - monto: Monto de la transacción</span>
<span class="sd">        - medio_pago: Medio de pago seleccionado</span>
<span class="sd">        - medio_cobro: Medio de cobro seleccionado</span>
<span class="sd">        - cliente_activo: Cliente que realiza la transacción</span>
<span class="sd">        - transaccion: Instancia de transacción creada</span>
<span class="sd">        - paso_actual: Número del paso actual (4)</span>
<span class="sd">        - total_pasos: Total de pasos en el proceso (4)</span>
<span class="sd">        - titulo_paso: Título descriptivo del paso</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;compra&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">compra_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span> <span class="ow">or</span> <span class="n">compra_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el tercer paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;confirmar&#39;</span><span class="p">:</span>
            <span class="n">cambios</span> <span class="o">=</span> <span class="n">verificar_cambio_cotizacion_sesion</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;compra&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cambios</span> <span class="ow">and</span> <span class="n">cambios</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hay_cambios&#39;</span><span class="p">):</span>
                <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">datos_transaccion</span> <span class="o">=</span> <span class="n">calcular_conversion</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="p">,</span> <span class="s1">&#39;compra&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">segmento</span><span class="p">)</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_base&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;cotizacion&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;beneficio_segmento&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_beneficio_segmento</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_beneficio_segmento&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_pago</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_pago&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_pago</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_pago&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_cobro</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_cobro&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_cobro</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_cobro&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_monto</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_monto&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_precio_final</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_precio_final&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">monto_original</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_original&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;cambios&#39;</span><span class="p">:</span> <span class="n">cambios</span><span class="p">,</span>
                    <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
                    <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Compra&#39;</span>
                <span class="p">}</span>
                
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_exito&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;cancelar&#39;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Has cancelado la transacción.&#39;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario canceló la transacción en el formulario&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># Limpiar datos de sesión</span>
            <span class="k">if</span> <span class="s1">&#39;compra_datos&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;precio_venta_inicial&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_venta_inicial&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;transaccion_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;aceptar&#39;</span><span class="p">:</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span>
            <span class="n">precios_actuales</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">get_precios_cliente</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_venta_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precios_actuales</span><span class="p">[</span><span class="s1">&#39;precio_venta&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Precios actualizados. Continuando con la transacción.&#39;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Compra&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
                <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;cancelar&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario cancela debido a cambios de cotización&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># Limpiar datos de sesión</span>
            <span class="k">if</span> <span class="s1">&#39;compra_datos&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;precio_venta_inicial&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_venta_inicial&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;transaccion_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Transacción cancelada debido a cambios en la cotización.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   
        <span class="c1"># Recuperar los datos de la sesión</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
            <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
            <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
            <span class="n">medio_cobro</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">):</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
            <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Compra&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="c1"># Crear la transacción en la base de datos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
                <span class="n">str_medio_pago</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Tarjeta de Crédito (**** **** **** </span><span class="si">{</span><span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;last4&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_medio_pago</span> <span class="o">=</span> <span class="n">medio_pago</span>
            <span class="n">datos_transaccion</span> <span class="o">=</span> <span class="n">calcular_conversion</span><span class="p">(</span><span class="n">monto</span><span class="p">,</span> <span class="n">moneda</span><span class="p">,</span> <span class="s1">&#39;compra&#39;</span><span class="p">,</span> <span class="n">medio_pago</span><span class="p">,</span> <span class="n">medio_cobro</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">segmento</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_diario</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span><span class="p">)</span> <span class="ow">or</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_mensual</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;El monto final excede sus límites diarios o mensuales. Reinicie el proceso con un monto menor.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">cliente</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
                <span class="n">tipo</span><span class="o">=</span><span class="s1">&#39;compra&#39;</span><span class="p">,</span>
                <span class="n">moneda</span><span class="o">=</span><span class="n">moneda</span><span class="p">,</span>
                <span class="n">monto</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">],</span>
                <span class="n">monto_original</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_original&#39;</span><span class="p">],</span>
                <span class="n">cotizacion</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;cotizacion&#39;</span><span class="p">],</span>
                <span class="n">precio_base</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_base&#39;</span><span class="p">],</span>
                <span class="n">beneficio_segmento</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;beneficio_segmento&#39;</span><span class="p">],</span>
                <span class="n">porc_beneficio_segmento</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_beneficio_segmento&#39;</span><span class="p">],</span>
                <span class="n">recargo_pago</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_pago&#39;</span><span class="p">],</span>
                <span class="n">porc_recargo_pago</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_pago&#39;</span><span class="p">],</span>
                <span class="n">recargo_cobro</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_cobro&#39;</span><span class="p">],</span>
                <span class="n">porc_recargo_cobro</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_cobro&#39;</span><span class="p">],</span>
                <span class="n">redondeo_efectivo_monto</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_monto&#39;</span><span class="p">],</span>
                <span class="n">redondeo_efectivo_precio_final</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_precio_final&#39;</span><span class="p">],</span>
                <span class="n">precio_final</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">],</span>
                <span class="n">medio_pago</span><span class="o">=</span><span class="n">str_medio_pago</span><span class="p">,</span>
                <span class="n">medio_cobro</span><span class="o">=</span><span class="n">medio_cobro</span><span class="p">,</span>
                <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">id</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al crear la transacción. Intente nuevamente.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
        
        <span class="n">cambios</span> <span class="o">=</span> <span class="n">verificar_cambio_cotizacion_sesion</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;compra&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cambios</span> <span class="ow">and</span> <span class="n">cambios</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hay_cambios&#39;</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;cambios&#39;</span><span class="p">:</span> <span class="n">cambios</span><span class="p">,</span>
                <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Compra&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
                <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
            <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Compra&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
            <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="compra_exito">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.compra_exito">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compra_exito</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Página final del proceso de compra: mensaje de éxito.</span>
<span class="sd">    </span>
<span class="sd">    Verifica si hay cambios en la cotización antes de finalizar la transacción.</span>
<span class="sd">    Si hay cambios, muestra el modal de confirmación. Si no hay cambios o el usuario</span>
<span class="sd">    acepta los nuevos precios, muestra confirmación de éxito.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP</span>
<span class="sd">        token (str, optional): Token de la transacción para retorno de la pasarela</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Página de éxito o modal de cambio de cotización</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/exito.html o transacciones/cotizacion_cambiada.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>

    <span class="n">transaccion</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Si viene token desde la pasarela, buscar la transacción por token</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
            
            <span class="c1"># Si viene desde la pasarela, validar los datos del pago</span>
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;Pendiente&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;exito&#39;</span><span class="p">:</span>
                <span class="c1"># Datos enviados por la pasarela</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">monto_pago</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monto&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">cuenta_pago</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nro_cuenta&#39;</span><span class="p">)</span>
                    <span class="n">banco_pago</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;banco&#39;</span><span class="p">)</span>
                    
                    <span class="c1"># Verificación de cuenta/billetera</span>
                    <span class="n">CUENTAS_GLOBAL_EXCHANGE</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;Transferencia Bancaria&#39;</span><span class="p">:</span> <span class="s1">&#39;SUDAMERIS-123456&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Tigo Money&#39;</span><span class="p">:</span> <span class="s1">&#39;TIGO-0981000001-1010101&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Billetera Personal&#39;</span><span class="p">:</span> <span class="s1">&#39;PERSONAL-0982000002-2020202&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Zimple&#39;</span><span class="p">:</span> <span class="s1">&#39;ZIMPLE-0983000003-3030303&#39;</span>
                    <span class="p">}</span>
                    <span class="c1"># Verificación del monto</span>
                    <span class="n">monto_valido</span> <span class="o">=</span> <span class="n">monto_pago</span> <span class="o">&gt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">==</span> <span class="s2">&quot;Transferencia Bancaria&quot;</span><span class="p">:</span>
                        <span class="c1"># Para transferencias, el CUENTAS_GLOBAL_EXCHANGE ya tiene banco+cuenta</span>
                        <span class="n">cuenta_valida</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">banco_pago</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">cuenta_pago</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="n">CUENTAS_GLOBAL_EXCHANGE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Para billeteras, la cuenta completa ya incluye el prefijo del banco</span>
                        <span class="n">cuenta_valida</span> <span class="o">=</span> <span class="n">cuenta_pago</span> <span class="o">==</span> <span class="n">CUENTAS_GLOBAL_EXCHANGE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">)</span>

                
                    <span class="k">if</span> <span class="n">monto_valido</span> <span class="ow">and</span> <span class="n">cuenta_valida</span><span class="p">:</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Confirmada&#39;</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">consumo_diario</span> <span class="o">+=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">consumo_mensual</span> <span class="o">+=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">ultimo_consumo</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
                        <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        <span class="n">guaranies</span> <span class="o">=</span> <span class="n">StockGuaranies</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                        <span class="n">guaranies</span><span class="o">.</span><span class="n">cantidad</span> <span class="o">+=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span> <span class="o">-</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_pago</span>
                        <span class="n">guaranies</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Pago confirmado exitosamente&#39;</span><span class="p">)</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/exito.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error en la validación del pago, se revierte el pago. Por favor, verifique los datos y el monto, e intente nuevamente.&#39;</span><span class="p">)</span>
                        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/informacion_pago.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                        
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Error procesando datos del pago: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al procesar los datos del pago&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Error reportado por la pasarela de pago&#39;</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al procesar el pago&#39;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Token de transacción inválido.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Flujo normal: buscar por sesión</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idt</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">)</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">idt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>

    <span class="n">compra_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compra_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compra_datos</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el cuarto paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">compra_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
            <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medio_pago_dict</span><span class="p">[</span><span class="s1">&#39;brand&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;VISA&#39;</span><span class="p">,</span><span class="s1">&#39;MASTERCARD&#39;</span><span class="p">]:</span>
                <span class="n">pago</span> <span class="o">=</span> <span class="n">procesar_pago_stripe</span><span class="p">(</span><span class="n">transaccion</span><span class="p">,</span> <span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pago</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Pago con tarjeta de crédito procesado exitosamente.&#39;</span><span class="p">)</span>
                    <span class="n">procesar_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
                    <span class="n">generar_token_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Error en el procesamiento del pago con tarjeta de crédito&#39;</span>
                    <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al procesar el pago con tarjeta de crédito. Intente nuevamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_monto_moneda&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Pago con tarjeta de crédito procesado exitosamente.&#39;</span><span class="p">)</span>
                <span class="n">procesar_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
                <span class="n">generar_token_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">generar_token_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al generar token de transacción. Intente nuevamente.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:compra_medio_cobro&#39;</span><span class="p">)</span>
            <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">!=</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/informacion_pago.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>

    <span class="c1"># Limpiar sesión</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/exito.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<span class="c1"># ============================================================================</span>
<span class="c1"># PROCESO DE VENTA DE MONEDAS</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="venta_monto_moneda">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.venta_monto_moneda">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">venta_monto_moneda</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Primer paso del proceso de venta: selección de moneda y monto.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar la moneda extranjera que desea vender</span>
<span class="sd">    y especificar el monto. Similar al proceso de compra pero con validaciones</span>
<span class="sd">    específicas para operaciones de venta.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Usuario debe tener un cliente activo</span>
<span class="sd">        - Monto debe cumplir con límites diarios y mensuales</span>
<span class="sd">        - Moneda debe estar activa en el sistema</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con datos del formulario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_moneda_monto.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - form: Formulario de selección de moneda y monto</span>
<span class="sd">        - paso_actual: Número del paso actual (1)</span>
<span class="sd">        - total_pasos: Total de pasos en el proceso (4)</span>
<span class="sd">        - titulo_paso: Título descriptivo del paso</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;venta&#39;)</span>
<span class="sd">        - limites_disponibles: Información de límites del cliente</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transacciones_pasadas</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Expira el tiempo para confirmar la transacción&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario sale del proceso de compra&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SeleccionMonedaMontoForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">moneda</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">]</span>
            <span class="n">monto</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;monto_decimal&#39;</span><span class="p">]</span>
            <span class="n">cliente_activo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span>
            <span class="c1"># Si pasa las validaciones, guardar los datos en la sesión</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">monto</span><span class="p">),</span>  <span class="c1"># Convertir Decimal a string para serialización</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
            <span class="c1"># Guardar precios iniciales en la sesión</span>
            <span class="n">precios</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">get_precios_cliente</span><span class="p">(</span><span class="n">cliente_activo</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_compra_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precios</span><span class="p">[</span><span class="s1">&#39;precio_compra&#39;</span><span class="p">]</span>
            <span class="c1"># Redireccionar al siguiente paso sin parámetros en la URL</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_pago&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Verificar si el usuario tiene un cliente activo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debes tener un cliente activo para realizar compras.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
         
        <span class="c1"># 1. Verificar si el cliente tiene un último consumo registrado</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span> <span class="o">!=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">ultimo_consumo</span><span class="o">.</span><span class="n">month</span> <span class="o">!=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Si cliente_activo.ultimo_consumo es None, no hacemos nada y los consumos</span>
        <span class="c1"># se mantienen en 0 (que es el valor inicial/correcto para un nuevo día/mes).</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SeleccionMonedaMontoForm</span><span class="p">()</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;disponible_diario&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_diario</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span><span class="p">),</span>
        <span class="s1">&#39;disponible_mensual&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_mensual</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span><span class="p">),</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Moneda y Monto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;venta&#39;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_moneda_monto.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="venta_medio_pago">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.venta_medio_pago">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">venta_medio_pago</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segundo paso del proceso de venta: selección del medio de pago.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar cómo va a recibir el pago por la moneda</span>
<span class="sd">    extranjera que está vendiendo. Para ventas, principalmente se ofrece</span>
<span class="sd">    efectivo, y para USD también tarjetas de crédito registradas.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Datos del paso anterior deben existir en sesión</span>
<span class="sd">        - Usuario debe tener cliente activo</span>
<span class="sd">        - Para tarjetas: solo disponibles para USD y clientes con tarjetas activas</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con selección de medio de pago</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_medio_pago.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda seleccionada en el paso anterior</span>
<span class="sd">        - monto: Monto seleccionado en el paso anterior</span>
<span class="sd">        - medios_pago: Lista de medios de pago disponibles</span>
<span class="sd">        - medio_pago_seleccionado: Medio actualmente seleccionado</span>
<span class="sd">        - cliente_activo: Cliente activo del usuario</span>
<span class="sd">        - paso_actual: Número del paso actual (2)</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;venta&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">venta_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span> <span class="ow">or</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el primer paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="c1"># Recuperar los datos de la sesión</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
        <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Verificar si es selección de medio de pago o avance al siguiente paso</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;seleccionar_medio&#39;</span><span class="p">:</span>
            <span class="c1"># Manejar la selección de medio de pago</span>
            <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medio_pago</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Actualizar los datos de la sesión (sin cambiar el paso_actual)</span>
                    <span class="n">venta_datos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;medio_pago&#39;</span><span class="p">:</span> <span class="n">medio_pago</span>
                    <span class="p">})</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">venta_datos</span>
                    <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                        <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de pago Tarjeta de Crédito (**** **** **** </span><span class="si">{</span><span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;last4&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">) seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de pago </span><span class="si">{</span><span class="n">medio_pago</span><span class="si">}</span><span class="s1"> seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_pago&#39;</span><span class="p">)</span>  <span class="c1"># Permanecer en el mismo paso</span>
        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al seleccionar el medio de pago. Intente nuevamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_pago&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;continuar&#39;</span><span class="p">:</span>
            <span class="c1"># Verificar que hay un medio de pago seleccionado</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe seleccionar un medio de pago antes de continuar.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_pago&#39;</span><span class="p">)</span>
            
            <span class="c1"># Actualizar el paso actual y continuar al siguiente paso</span>
            <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">venta_datos</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
    
    <span class="n">medios_pago_disponibles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Efectivo&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># Para ventas, verificar tarjetas activas solo para USD</span>
    <span class="k">if</span> <span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span> <span class="o">==</span> <span class="s1">&#39;USD&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">tiene_tarjetas_activas</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tarjeta</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">obtener_tarjetas_stripe</span><span class="p">():</span>
            <span class="n">medios_pago_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarjeta</span><span class="p">)</span>

    <span class="c1"># Obtener el medio de pago seleccionado actualmente (si hay uno)</span>
    <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
            <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">medio_pago_seleccionado</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
        <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
        <span class="s1">&#39;medios_pago&#39;</span><span class="p">:</span> <span class="n">medios_pago_disponibles</span><span class="p">,</span>
        <span class="s1">&#39;medio_pago_seleccionado&#39;</span><span class="p">:</span> <span class="n">medio_pago_seleccionado</span><span class="p">,</span>
        <span class="s1">&#39;cliente_activo&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Medio de Pago&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;venta&#39;</span>  <span class="c1"># Agregar contexto para diferenciar en plantilla</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_medio_pago.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="venta_medio_cobro">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.venta_medio_cobro">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">venta_medio_cobro</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tercer paso del proceso de venta: selección del medio de cobro.</span>
<span class="sd">    </span>
<span class="sd">    Permite al usuario seleccionar cómo va a entregar la moneda extranjera</span>
<span class="sd">    que está vendiendo. Incluye opciones como efectivo, cuentas bancarias</span>
<span class="sd">    registradas y billeteras electrónicas del cliente.</span>
<span class="sd">    </span>
<span class="sd">    Validaciones realizadas:</span>
<span class="sd">        - Datos de pasos anteriores deben existir en sesión</span>
<span class="sd">        - Usuario debe tener cliente activo</span>
<span class="sd">        - Medios disponibles según configuración del cliente</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con selección de medio de cobro</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza formulario o redirecciona al siguiente paso</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/seleccion_medio_cobro.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda seleccionada</span>
<span class="sd">        - monto: Monto seleccionado</span>
<span class="sd">        - medio_pago: Medio de pago seleccionado</span>
<span class="sd">        - medios_cobro: Lista de medios de cobro disponibles (efectivo, cuentas, billeteras)</span>
<span class="sd">        - medio_cobro_seleccionado: Medio de cobro actualmente seleccionado</span>
<span class="sd">        - cliente_activo: Cliente activo del usuario</span>
<span class="sd">        - paso_actual: Número del paso actual (3)</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;venta&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">venta_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span> <span class="ow">or</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el segundo paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_pago&#39;</span><span class="p">)</span>
    
    <span class="c1"># Recuperar los datos de la sesión</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
        <span class="c1"># Guardar valores iniciales de cotización</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;tasa_base_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">tasa_base</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;comision_compra_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">comision_compra</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;comision_venta_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moneda</span><span class="o">.</span><span class="n">comision_venta</span>
        <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
        <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Verificar si es selección de medio de cobro o avance al siguiente paso</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;seleccionar_medio&#39;</span><span class="p">:</span>
            <span class="c1"># Manejar la selección de medio de cobro</span>
            <span class="n">medio_cobro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medio_cobro</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Actualizar los datos de la sesión (sin cambiar el paso_actual)</span>
                    <span class="n">venta_datos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;medio_cobro&#39;</span><span class="p">:</span> <span class="n">medio_cobro</span>
                    <span class="p">})</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">venta_datos</span>
                    <span class="k">if</span> <span class="n">medio_cobro</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                        <span class="n">medio_cobro_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_cobro</span><span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de cobro </span><span class="si">{</span><span class="n">medio_cobro_dict</span><span class="p">[</span><span class="s2">&quot;tipo_billetera&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Medio de cobro </span><span class="si">{</span><span class="n">medio_cobro</span><span class="si">}</span><span class="s1"> seleccionado correctamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>  <span class="c1"># Permanecer en el mismo paso</span>
        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al seleccionar el medio de cobro. Intente nuevamente.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;continuar&#39;</span><span class="p">:</span>
            <span class="c1"># Verificar que hay un medio de cobro seleccionado</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe seleccionar un medio de cobro antes de continuar.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
            
            <span class="c1"># Actualizar el paso actual y continuar al siguiente paso</span>
            <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">venta_datos</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_confirmacion&#39;</span><span class="p">)</span>
    
    <span class="c1"># Construir lista de medios de cobro disponibles</span>
    <span class="n">medios_cobro_disponibles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Efectivo&#39;</span><span class="p">]</span>  <span class="c1"># Opción fija</span>
    
    <span class="c1"># Agregar cuentas bancarias si las hay</span>
    <span class="n">cuentas_bancarias</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">cuentas_bancarias</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cuenta</span> <span class="ow">in</span> <span class="n">cuentas_bancarias</span><span class="p">:</span>
        <span class="n">medio_descripcion</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cuenta bancaria - </span><span class="si">{</span><span class="n">cuenta</span><span class="o">.</span><span class="n">get_banco_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cuenta</span><span class="o">.</span><span class="n">numero_cuenta</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">medios_cobro_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medio_descripcion</span><span class="p">)</span>
    
    <span class="c1"># Agregar billeteras si las hay</span>
    <span class="n">billeteras</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">billeteras</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">billetera</span> <span class="ow">in</span> <span class="n">billeteras</span><span class="p">:</span>
        <span class="n">billetera_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">billetera</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;tipo_billetera&#39;</span><span class="p">:</span> <span class="n">billetera</span><span class="o">.</span><span class="n">get_tipo_billetera_display</span><span class="p">(),</span>
            <span class="s1">&#39;telefono&#39;</span><span class="p">:</span> <span class="n">billetera</span><span class="o">.</span><span class="n">telefono</span><span class="p">,</span>
            <span class="s1">&#39;nombre_titular&#39;</span><span class="p">:</span> <span class="n">billetera</span><span class="o">.</span><span class="n">nombre_titular</span><span class="p">,</span>
            <span class="s1">&#39;nro_documento&#39;</span><span class="p">:</span> <span class="n">billetera</span><span class="o">.</span><span class="n">nro_documento</span>
        <span class="p">}</span>
        <span class="n">medios_cobro_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">billetera_dict</span><span class="p">)</span>

    <span class="c1"># Obtener el medio de cobro seleccionado actualmente (si hay uno)</span>
    <span class="n">medio_cobro_seleccionado</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
            <span class="n">medio_cobro_seleccionado</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">medio_cobro_seleccionado</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;moneda&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
        <span class="s1">&#39;monto&#39;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
        <span class="s1">&#39;medio_pago&#39;</span><span class="p">:</span> <span class="n">medio_pago</span><span class="p">,</span>
        <span class="s1">&#39;medios_cobro&#39;</span><span class="p">:</span> <span class="n">medios_cobro_disponibles</span><span class="p">,</span>
        <span class="s1">&#39;medio_cobro_seleccionado&#39;</span><span class="p">:</span> <span class="n">medio_cobro_seleccionado</span><span class="p">,</span>
        <span class="s1">&#39;cliente_activo&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
        <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Selección de Medio de Cobro&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tipo_transaccion&#39;</span><span class="p">:</span> <span class="s1">&#39;venta&#39;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/seleccion_medio_cobro.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="venta_confirmacion">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.venta_confirmacion">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">venta_confirmacion</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cuarto paso del proceso de venta: confirmación y creación de transacción.</span>
<span class="sd">    </span>
<span class="sd">    Muestra un resumen completo de la transacción de venta y procede a crearla</span>
<span class="sd">    en la base de datos. Para ventas en efectivo, genera un token de seguridad</span>
<span class="sd">    con validez de 5 minutos.</span>
<span class="sd">    </span>
<span class="sd">    Acciones realizadas:</span>
<span class="sd">        - Creación de registro de transacción en base de datos</span>
<span class="sd">        - Generación de token para pagos en efectivo</span>
<span class="sd">        - Configuración del estado inicial como &#39;Pendiente&#39;</span>
<span class="sd">        - Vinculación con cliente y usuario activos</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP de confirmación</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza página de confirmación</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/confirmacion.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - moneda: Moneda de la transacción</span>
<span class="sd">        - monto: Monto de la transacción</span>
<span class="sd">        - medio_pago: Medio de pago seleccionado</span>
<span class="sd">        - medio_cobro: Medio de cobro seleccionado</span>
<span class="sd">        - cliente_activo: Cliente que realiza la transacción</span>
<span class="sd">        - transaccion: Instancia de transacción creada</span>
<span class="sd">        - paso_actual: Número del paso actual (4)</span>
<span class="sd">        - tipo_transaccion: Tipo de operación (&#39;venta&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="c1"># Verificar que existan datos del paso anterior</span>
    <span class="n">venta_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span> <span class="ow">or</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paso_actual&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el tercer paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">accion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accion&#39;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;confirmar&#39;</span><span class="p">:</span>
            <span class="n">cambios</span> <span class="o">=</span> <span class="n">verificar_cambio_cotizacion_sesion</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;venta&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cambios</span> <span class="ow">and</span> <span class="n">cambios</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hay_cambios&#39;</span><span class="p">):</span>
                <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">datos_transaccion</span> <span class="o">=</span> <span class="n">calcular_conversion</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="p">,</span> <span class="s1">&#39;venta&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">segmento</span><span class="p">)</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_base&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;cotizacion&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;beneficio_segmento&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_beneficio_segmento</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_beneficio_segmento&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_pago</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_pago&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_pago</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_pago&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_cobro</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_cobro&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_cobro</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_cobro&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_monto</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_monto&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_precio_final</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_precio_final&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">monto_original</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_original&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span> <span class="o">=</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;cambios&#39;</span><span class="p">:</span> <span class="n">cambios</span><span class="p">,</span>
                    <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">)),</span>
                    <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Venta&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
                    <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                    <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                <span class="p">}</span>
                
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_exito&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s1">&#39;cancelar&#39;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Has cancelado la transacción.&#39;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario canceló la transacción en el formulario&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># Limpiar datos de sesión</span>
            <span class="k">if</span> <span class="s1">&#39;venta_datos&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;precio_compra_inicial&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_compra_inicial&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;transaccion_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;aceptar&#39;</span><span class="p">:</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">precios_actuales</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">get_precios_cliente</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_compra_inicial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precios_actuales</span><span class="p">[</span><span class="s1">&#39;precio_compra&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Precios actualizados. Continuando con la transacción.&#39;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Venta&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
                <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;cancelar&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Usuario cancela debido a cambios de cotización&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># Limpiar datos de sesión</span>
            <span class="k">if</span> <span class="s1">&#39;venta_datos&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;precio_compra_inicial&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;precio_compra_inicial&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;transaccion_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Transacción cancelada debido a cambios en la cotización.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Recuperar los datos de la sesión</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;moneda&#39;</span><span class="p">])</span>
            <span class="n">monto</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">])</span>
            <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
            <span class="n">medio_cobro</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">):</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
            <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Venta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
            <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    
    <span class="c1"># Crear la transacción en la base de datos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
                <span class="n">str_medio_pago</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Tarjeta de Crédito (**** **** **** </span><span class="si">{</span><span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;last4&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_medio_pago</span> <span class="o">=</span> <span class="n">medio_pago</span>
            <span class="k">if</span> <span class="n">medio_cobro</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                <span class="n">medio_cobro_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_cobro</span><span class="p">)</span>
                <span class="n">str_medio_cobro</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">medio_cobro_dict</span><span class="p">[</span><span class="s2">&quot;tipo_billetera&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">medio_cobro_dict</span><span class="p">[</span><span class="s2">&quot;telefono&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_medio_cobro</span> <span class="o">=</span> <span class="n">medio_cobro</span>
                
            <span class="n">datos_transaccion</span> <span class="o">=</span> <span class="n">calcular_conversion</span><span class="p">(</span><span class="n">monto</span><span class="p">,</span> <span class="n">moneda</span><span class="p">,</span> <span class="s1">&#39;venta&#39;</span><span class="p">,</span> <span class="n">medio_pago</span><span class="p">,</span> <span class="n">medio_cobro</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">segmento</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_diario</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_diario</span><span class="p">)</span> <span class="ow">or</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">limite_mensual</span> <span class="o">-</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="o">.</span><span class="n">consumo_mensual</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;El monto final excede sus límites diarios o mensuales. Reinicie el proceso con un monto menor.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">str_medio_cobro</span> <span class="o">!=</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">StockGuaranies</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">cantidad</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;El monto a recibir excede la disponibilidad actual de guaraníes en el sistema. Reinicie el proceso con un monto menor o diferente medio de cobro.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">cliente</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">,</span>
                <span class="n">tipo</span><span class="o">=</span><span class="s1">&#39;venta&#39;</span><span class="p">,</span>
                <span class="n">moneda</span><span class="o">=</span><span class="n">moneda</span><span class="p">,</span>
                <span class="n">monto</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto&#39;</span><span class="p">],</span>
                <span class="n">monto_original</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_original&#39;</span><span class="p">],</span>
                <span class="n">cotizacion</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;cotizacion&#39;</span><span class="p">],</span>
                <span class="n">precio_base</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_base&#39;</span><span class="p">],</span>
                <span class="n">beneficio_segmento</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;beneficio_segmento&#39;</span><span class="p">],</span>
                <span class="n">porc_beneficio_segmento</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_beneficio_segmento&#39;</span><span class="p">],</span>
                <span class="n">recargo_pago</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_pago&#39;</span><span class="p">],</span>
                <span class="n">porc_recargo_pago</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_pago&#39;</span><span class="p">],</span>
                <span class="n">recargo_cobro</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;monto_recargo_cobro&#39;</span><span class="p">],</span>
                <span class="n">porc_recargo_cobro</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;porc_recargo_cobro&#39;</span><span class="p">],</span>
                <span class="n">redondeo_efectivo_monto</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_monto&#39;</span><span class="p">],</span>
                <span class="n">redondeo_efectivo_precio_final</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;redondeo_efectivo_precio_final&#39;</span><span class="p">],</span>
                <span class="n">precio_final</span><span class="o">=</span><span class="n">datos_transaccion</span><span class="p">[</span><span class="s1">&#39;precio_final&#39;</span><span class="p">],</span>
                <span class="n">medio_pago</span><span class="o">=</span><span class="n">str_medio_pago</span><span class="p">,</span>
                <span class="n">medio_cobro</span><span class="o">=</span><span class="n">str_medio_cobro</span><span class="p">,</span>
                <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">id</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al crear la transacción. Intente nuevamente.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
        
        <span class="n">cambios</span> <span class="o">=</span> <span class="n">verificar_cambio_cotizacion_sesion</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;venta&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cambios</span> <span class="ow">and</span> <span class="n">cambios</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hay_cambios&#39;</span><span class="p">):</span>
            <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;cambios&#39;</span><span class="p">:</span> <span class="n">cambios</span><span class="p">,</span>
                <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
                <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Venta&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
                <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
            <span class="s1">&#39;paso_actual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;titulo_paso&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmación de Venta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_2fa&#39;</span><span class="p">:</span> <span class="n">is_2fa_enabled</span><span class="p">(),</span>
            <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;has_email&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/confirmacion.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="venta_exito">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.venta_exito">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">venta_exito</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Página final del proceso de venta: mensaje de éxito.</span>
<span class="sd">    </span>
<span class="sd">    Verifica si hay cambios en la cotización antes de finalizar la transacción.</span>
<span class="sd">    Si hay cambios, muestra el modal de confirmación. Si no hay cambios o el usuario</span>
<span class="sd">    acepta los nuevos precios, muestra confirmación de éxito.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Página de éxito o modal de cambio de cotización</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/exito.html o transacciones/cotizacion_cambiada.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar que el usuario tenga un cliente activo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cliente_activo</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe tener un cliente activo seleccionado para continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idt</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">)</span>
        <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">idt</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>

    <span class="n">venta_datos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;venta_datos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">venta_datos</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Debe completar el cuarto paso antes de continuar.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">medio_pago</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="p">[</span><span class="s1">&#39;medio_pago&#39;</span><span class="p">]</span>
        <span class="n">medio_cobro</span> <span class="o">=</span> <span class="n">venta_datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medio_cobro&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al recuperar los datos. Reinicie el proceso.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">medio_pago</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
            <span class="n">medio_pago_dict</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">medio_pago</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">procesar_pago_stripe</span><span class="p">(</span><span class="n">transaccion</span><span class="p">,</span> <span class="n">medio_pago_dict</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Pago con tarjeta de crédito procesado exitosamente.&#39;</span><span class="p">)</span>
                <span class="n">procesar_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">medio_cobro</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">:</span>
                    <span class="n">generar_token_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Error en la transacción automática de venta&#39;</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Hubo un error de pago o de cobro automático. Intente nuevamente.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_monto_moneda&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">generar_token_transaccion</span><span class="p">(</span><span class="n">transaccion</span><span class="p">)</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">transaccion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Error al generar token de transacción. Intente nuevamente.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:venta_medio_cobro&#39;</span><span class="p">)</span>
            
    <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transaccion_id&#39;</span><span class="p">]</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/exito.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="c1"># ============================================================================</span>
<span class="c1"># HISTORIAL Y CONSULTA DE TRANSACCIONES</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="historial_transacciones">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.historial_transacciones">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">historial_transacciones</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cliente_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista principal para el historial y consulta de transacciones.</span>
<span class="sd">    </span>
<span class="sd">    Muestra un listado completo de transacciones con capacidades de filtrado</span>
<span class="sd">    avanzado por cliente, usuario, tipo de operación y estado. Si se proporciona</span>
<span class="sd">    un cliente_id específico, filtra solo las transacciones de ese cliente.</span>
<span class="sd">    </span>
<span class="sd">    Filtros disponibles:</span>
<span class="sd">        - Búsqueda por nombre/documento de cliente o usuario</span>
<span class="sd">        - Tipo de operación (compra/venta)</span>
<span class="sd">        - Estado de transacción (pendiente/completada/etc.)</span>
<span class="sd">        - Usuario específico que procesó la transacción</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con parámetros de filtro</span>
<span class="sd">        cliente_id (int, optional): ID específico de cliente para filtrar</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Listado de transacciones filtrado</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/historial_transacciones.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - transacciones: QuerySet de transacciones filtradas</span>
<span class="sd">        - busqueda: Término de búsqueda aplicado</span>
<span class="sd">        - tipo_operacion: Filtro de tipo aplicado</span>
<span class="sd">        - estado_filtro: Filtro de estado aplicado</span>
<span class="sd">        - cliente_filtrado: Cliente específico si aplica</span>
<span class="sd">        - usuario_filtro: Usuario específico si aplica</span>
<span class="sd">        - usuarios_cliente: Usuarios asociados al cliente (si aplica)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cliente</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente_id</span><span class="p">)</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">cliente</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-fecha_hora&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Cliente no encontrado&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:historial&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">clientes_operados</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No tienes permiso para ver el historial de este cliente.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    <span class="n">transacciones_pasadas</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">cliente</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Expira el tiempo para confirmar la transacción&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># Obtener parámetros de filtrado</span>
    <span class="n">busqueda</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;busqueda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">tipo_operacion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_operacion&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">estado_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">usuario_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usuario&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Aplicar filtros según parámetros recibidos</span>
    <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
        <span class="c1"># Buscar por cliente o usuario solo cuando no hay cliente filtrado</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__nombre__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span> 
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__numero_documento__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__usuarios__username__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">tipo_operacion</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo</span><span class="o">=</span><span class="n">tipo_operacion</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">estado_filtro</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado__iexact</span><span class="o">=</span><span class="n">estado_filtro</span><span class="p">)</span>
    
    <span class="c1"># Filtrar por usuario si se especifica</span>
    <span class="k">if</span> <span class="n">usuario_filtro</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">usuario_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">usuario_filtro</span><span class="p">)</span>
            <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario_id</span><span class="o">=</span><span class="n">usuario_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transacciones&#39;</span><span class="p">:</span> <span class="n">transacciones</span><span class="p">,</span>
        <span class="s1">&#39;busqueda&#39;</span><span class="p">:</span> <span class="n">busqueda</span><span class="p">,</span>
        <span class="s1">&#39;tipo_operacion&#39;</span><span class="p">:</span> <span class="n">tipo_operacion</span><span class="p">,</span>
        <span class="s1">&#39;estado_filtro&#39;</span><span class="p">:</span> <span class="n">estado_filtro</span><span class="p">,</span>
        <span class="s1">&#39;usuario_filtro&#39;</span><span class="p">:</span> <span class="n">usuario_filtro</span><span class="p">,</span>
        <span class="s1">&#39;cliente_filtrado&#39;</span><span class="p">:</span> <span class="n">cliente</span><span class="p">,</span>
        <span class="s1">&#39;usuarios_cliente&#39;</span><span class="p">:</span> <span class="n">cliente</span><span class="o">.</span><span class="n">usuarios</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/historial_transacciones.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="detalle_historial">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.detalle_historial">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">detalle_historial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">transaccion_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista de detalle para una transacción específica.</span>
<span class="sd">    </span>
<span class="sd">    Muestra información completa y detallada de una transacción individual,</span>
<span class="sd">    incluyendo todos los datos relevantes como montos calculados, medios</span>
<span class="sd">    de pago/cobro, información del cliente y estado actual.</span>
<span class="sd">    </span>
<span class="sd">    Cálculos realizados:</span>
<span class="sd">        - Para compras: Convierte monto extranjero a guaraníes usando precio de venta</span>
<span class="sd">        - Para ventas: Convierte monto extranjero a guaraníes usando precio de compra</span>
<span class="sd">        - Aplica beneficios del segmento del cliente</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP</span>
<span class="sd">        transaccion_id (int): ID de la transacción a mostrar</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Página de detalle o redirecciona si no existe</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/detalle_transaccion.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - transaccion: Instancia de la transacción</span>
<span class="sd">        - monto_origen: Monto en moneda de origen (guaraníes o extranjera)</span>
<span class="sd">        - monto_destino: Monto en moneda de destino (extranjera o guaraníes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">transaccion_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;La transacción solicitada no existe.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:historial&#39;</span><span class="p">)</span>
    <span class="n">transacciones_pasadas</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transacciones_pasadas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">fecha_hora</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="s1">&#39;Cancelada&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">razon</span> <span class="o">=</span> <span class="s1">&#39;Expira el tiempo para confirmar la transacción&#39;</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">clientes_operados</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No tienes permiso para ver el historial de este cliente.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transaccion&#39;</span><span class="p">:</span> <span class="n">transaccion</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/detalle_historial.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="ver_variables">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.ver_variables">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;transacciones.edicion&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ver_variables</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para ver variables de gestión de transacciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;limites&#39;</span><span class="p">:</span> <span class="n">LimiteGlobal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
        <span class="s1">&#39;recargos&#39;</span><span class="p">:</span> <span class="n">Recargos</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/ver_variables.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="editar_variables">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.editar_variables">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;transacciones.edicion&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">editar_variables</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para editar variables de gestión de transacciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">VariablesForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Variables actualizadas correctamente.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;transacciones:ver_variables&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">VariablesForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/editar_variables.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="revisar_tausers">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.revisar_tausers">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;transacciones.revision&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">revisar_tausers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para revisar la información de los TAUsers.</span>
<span class="sd">    </span>
<span class="sd">    Muestra un listado de todos los TAUsers del sistema con su información básica</span>
<span class="sd">    incluyendo puerto, estado de activación (detectado dinámicamente) y opciones de acción.</span>
<span class="sd">    </span>
<span class="sd">    Funcionalidades:</span>
<span class="sd">        - Listado completo de TAUsers</span>
<span class="sd">        - Búsqueda por puerto</span>
<span class="sd">        - Filtrado por estado (activo/inactivo) detectado automáticamente</span>
<span class="sd">        - Estadísticas de TAUsers activos e inactivos</span>
<span class="sd">        - Opción de ver detalles de cada TAUser</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con parámetros de filtro opcionales</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Renderiza listado de TAUsers</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/tausers_lista.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - tausers: Lista de TAUsers con estado detectado dinámicamente</span>
<span class="sd">        - busqueda: Término de búsqueda aplicado</span>
<span class="sd">        - tausers_activos: Cantidad de TAUsers activos</span>
<span class="sd">        - tausers_inactivos: Cantidad de TAUsers inactivos</span>
<span class="sd">        - total_tausers_sistema: Total de TAUsers en el sistema</span>
<span class="sd">        - filtro_estado: Estado seleccionado para filtrar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener todos los TAUsers</span>
    <span class="n">todos_los_tausers</span> <span class="o">=</span> <span class="n">Tauser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">tausers_query</span> <span class="o">=</span> <span class="n">todos_los_tausers</span>
    
    <span class="c1"># Manejar búsqueda por sucursal</span>
    <span class="n">busqueda</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;busqueda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
        <span class="n">tausers_query</span> <span class="o">=</span> <span class="n">tausers_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sucursal__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por número de Tauser</span>
    <span class="n">tausers_query</span> <span class="o">=</span> <span class="n">tausers_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    
    <span class="c1"># Obtener filtro de estado</span>
    <span class="n">filtro_estado</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Convertir QuerySet a lista y agregar estado dinámico</span>
    <span class="n">tausers_con_estado</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tausers_activos_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tausers_inactivos_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">tauser</span> <span class="ow">in</span> <span class="n">tausers_query</span><span class="p">:</span>
        <span class="c1"># Detectar estado dinámicamente</span>
        <span class="n">esta_activo</span> <span class="o">=</span> <span class="n">tauser</span><span class="o">.</span><span class="n">esta_activo</span><span class="p">()</span>
        
        <span class="c1"># Aplicar filtro de estado si se especifica</span>
        <span class="k">if</span> <span class="n">filtro_estado</span> <span class="o">==</span> <span class="s1">&#39;activo&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">esta_activo</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">filtro_estado</span> <span class="o">==</span> <span class="s1">&#39;inactivo&#39;</span> <span class="ow">and</span> <span class="n">esta_activo</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="c1"># Agregar el tauser con su estado detectado</span>
        <span class="n">tauser</span><span class="o">.</span><span class="n">activo</span> <span class="o">=</span> <span class="n">esta_activo</span>  <span class="c1"># Agregar atributo temporal</span>
        <span class="n">tausers_con_estado</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tauser</span><span class="p">)</span>
        
        <span class="c1"># Contar para estadísticas</span>
        <span class="k">if</span> <span class="n">esta_activo</span><span class="p">:</span>
            <span class="n">tausers_activos_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tausers_inactivos_count</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Total de TAUsers en el sistema (sin filtrar)</span>
    <span class="n">total_tausers_sistema</span> <span class="o">=</span> <span class="n">todos_los_tausers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tausers&#39;</span><span class="p">:</span> <span class="n">tausers_con_estado</span><span class="p">,</span>
        <span class="s1">&#39;tausers_activos&#39;</span><span class="p">:</span> <span class="n">tausers_activos_count</span><span class="p">,</span>
        <span class="s1">&#39;tausers_inactivos&#39;</span><span class="p">:</span> <span class="n">tausers_inactivos_count</span><span class="p">,</span>
        <span class="s1">&#39;busqueda&#39;</span><span class="p">:</span> <span class="n">busqueda</span><span class="p">,</span>
        <span class="s1">&#39;filtro_estado&#39;</span><span class="p">:</span> <span class="n">filtro_estado</span><span class="p">,</span>
        <span class="s1">&#39;total_tausers_sistema&#39;</span><span class="p">:</span> <span class="n">total_tausers_sistema</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/tausers_lista.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="tauser_detalle">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.tauser_detalle">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;transacciones.revision&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tauser_detalle</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para mostrar los detalles completos de un TAUser específico.</span>
<span class="sd">    </span>
<span class="sd">    Muestra información detallada del TAUser incluyendo puerto, estado,</span>
<span class="sd">    billetes asociados y sus cantidades disponibles.</span>
<span class="sd">    Incluye filtrado por moneda para billetes.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP</span>
<span class="sd">        pk (int): ID del TAUser a mostrar</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Página de detalle del TAUser</span>
<span class="sd">        </span>
<span class="sd">    Template:</span>
<span class="sd">        transacciones/tauser_detalles.html</span>
<span class="sd">        </span>
<span class="sd">    Context:</span>
<span class="sd">        - tauser: Instancia del TAUser</span>
<span class="sd">        - billetes_tauser: QuerySet de billetes asociados al TAUser</span>
<span class="sd">        - monedas_disponibles: Lista de monedas que tienen billetes en este TAUser</span>
<span class="sd">        - moneda_filtro: Moneda seleccionada para filtrar (si aplica)  </span>
<span class="sd">        - totales_por_moneda: Diccionario con totales por moneda</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BilletesTauser</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">monedas.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Moneda</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Count</span>
    
    <span class="n">tauser</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tauser</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    
    <span class="c1"># Obtener todos los billetes del TAUser (sin filtrar para obtener todas las monedas disponibles)</span>
    <span class="n">todos_billetes_tauser</span> <span class="o">=</span> <span class="n">BilletesTauser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tauser</span><span class="o">=</span><span class="n">tauser</span><span class="p">)</span>
    
    <span class="c1"># Calcular totales por moneda</span>
    <span class="n">totales_por_moneda</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Total para guaraníes (denominaciones sin moneda)</span>
    <span class="n">total_guaranies</span> <span class="o">=</span> <span class="n">todos_billetes_tauser</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">denominacion__moneda__isnull</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;cantidad&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="p">(</span><span class="s1">&#39;denominacion__valor&#39;</span><span class="p">))</span>
    <span class="p">)[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">total_guaranies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">totales_por_moneda</span><span class="p">[</span><span class="s1">&#39;guarani&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nombre&#39;</span><span class="p">:</span> <span class="s1">&#39;Guaraní&#39;</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_guaranies</span><span class="p">,</span>
            <span class="s1">&#39;simbolo&#39;</span><span class="p">:</span> <span class="s1">&#39;Gs.&#39;</span>
        <span class="p">}</span>
    
    <span class="c1"># Totales para monedas extranjeras</span>
    <span class="k">for</span> <span class="n">moneda</span> <span class="ow">in</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">total_moneda</span> <span class="o">=</span> <span class="n">todos_billetes_tauser</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">denominacion__moneda</span><span class="o">=</span><span class="n">moneda</span>
        <span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;cantidad&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="p">(</span><span class="s1">&#39;denominacion__valor&#39;</span><span class="p">))</span>
        <span class="p">)[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">total_moneda</span> <span class="ow">and</span> <span class="n">total_moneda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">totales_por_moneda</span><span class="p">[</span><span class="n">moneda</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;nombre&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_moneda</span><span class="p">,</span>
                <span class="s1">&#39;simbolo&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span>
            <span class="p">}</span>
    
    <span class="c1"># Obtener todas las monedas que tienen billetes en este TAUser (antes de aplicar filtros)</span>
    <span class="n">monedas_con_billetes</span> <span class="o">=</span> <span class="n">todos_billetes_tauser</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;denominacion__moneda&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="n">monedas_disponibles</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Agregar guaraní si hay billetes sin moneda (denominación de guaraníes)</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">monedas_con_billetes</span><span class="p">:</span>
        <span class="n">monedas_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;guarani&#39;</span><span class="p">,</span> <span class="s1">&#39;nombre&#39;</span><span class="p">:</span> <span class="s1">&#39;Guaraní&#39;</span><span class="p">})</span>
    
    <span class="c1"># Agregar monedas extranjeras</span>
    <span class="k">for</span> <span class="n">moneda_id</span> <span class="ow">in</span> <span class="n">monedas_con_billetes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">moneda_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">moneda</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">moneda_id</span><span class="p">)</span>
                <span class="n">monedas_disponibles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;nombre&#39;</span><span class="p">:</span> <span class="n">moneda</span><span class="o">.</span><span class="n">nombre</span><span class="p">})</span>
            <span class="k">except</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
    
    <span class="c1"># Ahora aplicar el filtro para mostrar los billetes</span>
    <span class="n">billetes_tauser_query</span> <span class="o">=</span> <span class="n">todos_billetes_tauser</span>
    
    <span class="c1"># Obtener parámetro de filtro de moneda</span>
    <span class="n">moneda_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;moneda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Aplicar filtro de moneda si se especifica</span>
    <span class="k">if</span> <span class="n">moneda_filtro</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">moneda_filtro</span> <span class="o">==</span> <span class="s1">&#39;guarani&#39;</span><span class="p">:</span>
            <span class="n">billetes_tauser_query</span> <span class="o">=</span> <span class="n">billetes_tauser_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">denominacion__moneda__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">moneda_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">moneda_filtro</span><span class="p">)</span>
                <span class="n">billetes_tauser_query</span> <span class="o">=</span> <span class="n">billetes_tauser_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">denominacion__moneda_id</span><span class="o">=</span><span class="n">moneda_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
    
    <span class="n">billetes_tauser</span> <span class="o">=</span> <span class="n">billetes_tauser_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;denominacion__moneda&#39;</span><span class="p">,</span> <span class="s1">&#39;denominacion__valor&#39;</span><span class="p">)</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tauser&#39;</span><span class="p">:</span> <span class="n">tauser</span><span class="p">,</span>
        <span class="s1">&#39;billetes_tauser&#39;</span><span class="p">:</span> <span class="n">billetes_tauser</span><span class="p">,</span>
        <span class="s1">&#39;monedas_disponibles&#39;</span><span class="p">:</span> <span class="n">monedas_disponibles</span><span class="p">,</span>
        <span class="s1">&#39;moneda_filtro&#39;</span><span class="p">:</span> <span class="n">moneda_filtro</span><span class="p">,</span>
        <span class="s1">&#39;totales_por_moneda&#39;</span><span class="p">:</span> <span class="n">totales_por_moneda</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;transacciones/tauser_detalles.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="verificar_estado_tauser">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.verificar_estado_tauser">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;transacciones.revision&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="k">def</span><span class="w"> </span><span class="nf">verificar_estado_tauser</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tauser_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista AJAX para verificar el estado de un TAUser específico.</span>
<span class="sd">    </span>
<span class="sd">    Útil para verificaciones individuales sin recargar toda la página.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP (debe ser AJAX)</span>
<span class="sd">        tauser_id (int): ID del TAUser a verificar</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        JsonResponse: Estado del TAUser y información adicional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tauser</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tauser</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">tauser_id</span><span class="p">)</span>
        <span class="n">esta_activo</span> <span class="o">=</span> <span class="n">tauser</span><span class="o">.</span><span class="n">esta_activo</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;tauser_id&#39;</span><span class="p">:</span> <span class="n">tauser</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;puerto&#39;</span><span class="p">:</span> <span class="n">tauser</span><span class="o">.</span><span class="n">puerto</span><span class="p">,</span>
            <span class="s1">&#39;activo&#39;</span><span class="p">:</span> <span class="n">esta_activo</span><span class="p">,</span>
            <span class="s1">&#39;estado_texto&#39;</span><span class="p">:</span> <span class="s1">&#39;Activo&#39;</span> <span class="k">if</span> <span class="n">esta_activo</span> <span class="k">else</span> <span class="s1">&#39;Inactivo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">tauser</span><span class="o">.</span><span class="n">puerto</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="n">Tauser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;TAUser no encontrado&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></div>

    
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="recibir_pago">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.recibir_pago">[documentos]</a>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span><span class="w"> </span><span class="nf">recibir_pago</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Vista para recibir y verificar notificaciones de la pasarela&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recibiendo notificación de pago&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Log de headers para debug</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Headers recibidos: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            

            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Datos recibidos: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">estado</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">)</span>
            <span class="n">monto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monto&#39;</span><span class="p">)</span>
            <span class="n">tipo_pago</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_pago&#39;</span><span class="p">)</span>
            
            <span class="c1"># Validar datos</span>
            <span class="k">if</span> <span class="n">estado</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exito&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelado&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estado inválido recibido: </span><span class="si">{</span><span class="n">estado</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Estado inválido&#39;</span><span class="p">})</span>
            
            <span class="k">if</span> <span class="n">estado</span> <span class="o">!=</span> <span class="s1">&#39;cancelado&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">monto</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Monto requerido no recibido&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Monto requerido&#39;</span><span class="p">})</span>

            <span class="c1"># Procesar según estado</span>
            <span class="k">if</span> <span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;exito&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pago exitoso procesado: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Pago procesado correctamente&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en pago: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Error procesando pago&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pago cancelado: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Pago cancelado&#39;</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decodificando JSON: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;JSON inválido&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inesperado: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Método no permitido&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;mensaje&#39;</span><span class="p">:</span> <span class="s1">&#39;Método no permitido&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">)</span></div>




<span class="c1"># ============================================================================</span>
<span class="c1"># VISTAS PARA DESCARGA DE HISTORIAL DE TRANSACCIONES</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="descargar_historial_pdf">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.descargar_historial_pdf">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">descargar_historial_pdf</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para descargar el historial de transacciones en formato PDF.</span>
<span class="sd">    </span>
<span class="sd">    Genera un archivo PDF profesional con las transacciones filtradas, donde cada </span>
<span class="sd">    transacción se presenta en su propia página individual con títulos, filtros </span>
<span class="sd">    aplicados y detalles completos de la operación.</span>
<span class="sd">    </span>
<span class="sd">    Características del PDF generado:</span>
<span class="sd">        - Formato A4 con márgenes de 2cm en todos los bordes</span>
<span class="sd">        - Cada página contiene: títulos corporativos, filtros aplicados y una transacción</span>
<span class="sd">        - Tablas optimizadas con fuentes legibles y espaciado profesional</span>
<span class="sd">        - Información completa de cada transacción incluyendo cálculos y estados</span>
<span class="sd">        - Formato de fecha/hora sincronizado con la zona horaria local</span>
<span class="sd">    </span>
<span class="sd">    Filtros soportados:</span>
<span class="sd">        - cliente: ID del cliente específico (requerido)</span>
<span class="sd">        - busqueda: Búsqueda por nombre/documento de cliente o username de usuario</span>
<span class="sd">        - tipo_operacion: Filtro por tipo (&#39;compra&#39; o &#39;venta&#39;)</span>
<span class="sd">        - estado: Filtro por estado de transacción</span>
<span class="sd">        - usuario: ID del usuario que procesó la transacción</span>
<span class="sd">    </span>
<span class="sd">    Seguridad:</span>
<span class="sd">        - Verifica permisos del usuario para acceder al cliente solicitado</span>
<span class="sd">        - Valida existencia del cliente antes de procesar</span>
<span class="sd">        - Aplica los mismos filtros de seguridad que la vista de historial</span>
<span class="sd">    </span>
<span class="sd">    Estructura del PDF:</span>
<span class="sd">        - Página 1: Títulos + Filtros + Primera transacción</span>
<span class="sd">        - Páginas N: Títulos + Filtros + Transacción N</span>
<span class="sd">        - Cada transacción incluye: tabla principal y tabla de detalles expandida</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con parámetros de filtro en GET</span>
<span class="sd">            - cliente (str): ID del cliente (requerido)</span>
<span class="sd">            - busqueda (str, opcional): Término de búsqueda</span>
<span class="sd">            - tipo_operacion (str, opcional): &#39;compra&#39; o &#39;venta&#39;</span>
<span class="sd">            - estado (str, opcional): Estado de la transacción</span>
<span class="sd">            - usuario (str, opcional): ID del usuario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Archivo PDF para descarga con content-type &#39;application/pdf&#39;</span>
<span class="sd">            - Nombre del archivo: &#39;historial_transacciones_{cliente_nombre}.pdf&#39;</span>
<span class="sd">            - Headers configurados para descarga automática</span>
<span class="sd">            </span>
<span class="sd">    Raises:</span>
<span class="sd">        HttpResponse(400): Si no se proporciona ID de cliente</span>
<span class="sd">        HttpResponse(404): Si el cliente no existe</span>
<span class="sd">        redirect(&#39;inicio&#39;): Si el usuario no tiene permisos para el cliente</span>
<span class="sd">    </span>
<span class="sd">    Dependencias:</span>
<span class="sd">        - ReportLab: Para generación de PDF (SimpleDocTemplate, Table, etc.)</span>
<span class="sd">        - Django timezone: Para formateo de fechas consistente</span>
<span class="sd">        - Modelos: Cliente, Transaccion, Usuario</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.pdfgen</span><span class="w"> </span><span class="kn">import</span> <span class="n">canvas</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.pagesizes</span><span class="w"> </span><span class="kn">import</span> <span class="n">letter</span><span class="p">,</span> <span class="n">A4</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">getSampleStyleSheet</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.platypus</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">TableStyle</span><span class="p">,</span> <span class="n">Paragraph</span><span class="p">,</span> <span class="n">Spacer</span><span class="p">,</span> <span class="n">PageBreak</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.units</span><span class="w"> </span><span class="kn">import</span> <span class="n">inch</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
    
    <span class="c1"># Obtener parámetros de filtro</span>
    <span class="n">cliente_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">)</span>
    <span class="n">busqueda</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;busqueda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">tipo_operacion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_operacion&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">estado_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">usuario_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usuario&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Obtener transacciones con los mismos filtros que la vista principal</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cliente_id</span><span class="p">:</span>
            <span class="n">cliente</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente_id</span><span class="p">)</span>
            <span class="n">transacciones</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">cliente</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-fecha_hora&#39;</span><span class="p">)</span>
            
            <span class="c1"># Verificar permisos del usuario</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">clientes_operados</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No tienes permiso para descargar el historial de este cliente.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Cliente no especificado&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Cliente no encontrado&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
    
    <span class="c1"># Aplicar los mismos filtros que en la vista de historial</span>
    <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__nombre__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span> 
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__numero_documento__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__usuarios__username__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">tipo_operacion</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo</span><span class="o">=</span><span class="n">tipo_operacion</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">estado_filtro</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado__iexact</span><span class="o">=</span><span class="n">estado_filtro</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">usuario_filtro</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">usuario_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">usuario_filtro</span><span class="p">)</span>
            <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario_id</span><span class="o">=</span><span class="n">usuario_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
    
    <span class="c1"># Crear el PDF</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">letter</span><span class="p">)</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="n">getSampleStyleSheet</span><span class="p">()</span>
    <span class="n">story</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Crear sección de transacciones con detalles</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transaccion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transacciones</span><span class="p">):</span>
        <span class="c1"># Si no es la primera transacción, agregar salto de página</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PageBreak</span><span class="p">())</span>
        
        <span class="c1"># Agregar títulos y filtros en cada página</span>
        <span class="c1"># Título de la empresa</span>
        <span class="n">company_title</span> <span class="o">=</span> <span class="s2">&quot;Global Exchange&quot;</span>
        <span class="n">title_style</span> <span class="o">=</span> <span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s1">&#39;CompactTitle&#39;</span><span class="p">)</span>
        <span class="n">title_style</span><span class="o">.</span><span class="n">fontSize</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Ligeramente aumentado</span>
        <span class="n">title_style</span><span class="o">.</span><span class="n">leading</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="n">company_title</span><span class="p">,</span> <span class="n">title_style</span><span class="p">))</span>
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># Ligeramente aumentado</span>
        
        <span class="c1"># Título del historial centrado</span>
        <span class="n">historial_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Historial de Transacciones - </span><span class="si">{</span><span class="n">cliente</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Crear estilo centrado para el título</span>
        <span class="n">centered_style</span> <span class="o">=</span> <span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Heading1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s1">&#39;CenteredHeading1&#39;</span><span class="p">)</span>
        <span class="n">centered_style</span><span class="o">.</span><span class="n">fontSize</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># Ligeramente aumentado</span>
        <span class="n">centered_style</span><span class="o">.</span><span class="n">leading</span> <span class="o">=</span> <span class="mi">18</span>
        <span class="n">centered_style</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 = CENTER</span>
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="n">historial_title</span><span class="p">,</span> <span class="n">centered_style</span><span class="p">))</span>
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># Ligeramente aumentado</span>
        
        <span class="c1"># Información de filtros aplicados</span>
        <span class="k">if</span> <span class="n">busqueda</span> <span class="ow">or</span> <span class="n">tipo_operacion</span> <span class="ow">or</span> <span class="n">estado_filtro</span> <span class="ow">or</span> <span class="n">usuario_filtro</span><span class="p">:</span>
            <span class="n">filtro_style</span> <span class="o">=</span> <span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Normal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s1">&#39;CompactNormal&#39;</span><span class="p">)</span>
            <span class="n">filtro_style</span><span class="o">.</span><span class="n">fontSize</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="n">filtro_style</span><span class="o">.</span><span class="n">leading</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="s2">&quot;Filtros aplicados:&quot;</span><span class="p">,</span> <span class="n">filtro_style</span><span class="p">))</span>
            <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># Ligeramente aumentado</span>
            
            <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
                <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• Búsqueda: &#39;</span><span class="si">{</span><span class="n">busqueda</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">filtro_style</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tipo_operacion</span><span class="p">:</span>
                <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• Tipo de operación: </span><span class="si">{</span><span class="n">tipo_operacion</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filtro_style</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">estado_filtro</span><span class="p">:</span>
                <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• Estado: </span><span class="si">{</span><span class="n">estado_filtro</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filtro_style</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">usuario_filtro</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">usuarios.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Usuario</span>
                    <span class="n">usuario</span> <span class="o">=</span> <span class="n">Usuario</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">usuario_filtro</span><span class="p">)</span>
                    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• Usuario: </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">nombre_completo</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">usuario</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filtro_style</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            
            <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Ligeramente aumentado</span>
        
        <span class="c1"># Crear tabla principal para cada transacción</span>
        <span class="c1"># Usar timezone local como en el template HTML</span>
        <span class="n">fecha_hora_local</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">fecha_hora</span><span class="p">)</span>
        <span class="n">fecha_str</span> <span class="o">=</span> <span class="n">fecha_hora_local</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">usuario_str</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">usuario</span><span class="o">.</span><span class="n">nombre_completo</span><span class="p">()</span> <span class="ow">or</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">usuario</span><span class="o">.</span><span class="n">username</span>
        <span class="n">operacion_str</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="c1"># Formatear el monto con los decimales correspondientes a la moneda</span>
        <span class="n">monto_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">moneda_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">estado_str</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span>
        
        <span class="c1"># Cada transacción tiene su propio encabezado</span>
        <span class="n">moneda_simbolo</span> <span class="o">=</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span>  <span class="c1"># Solo el símbolo sin monto</span>
        <span class="n">main_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;Fecha/Hora&#39;</span><span class="p">,</span> <span class="s1">&#39;Operación&#39;</span><span class="p">,</span> <span class="s1">&#39;Moneda&#39;</span><span class="p">,</span> <span class="s1">&#39;Estado&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">fecha_str</span><span class="p">,</span> <span class="n">operacion_str</span><span class="p">,</span> <span class="n">moneda_simbolo</span><span class="p">,</span> <span class="n">estado_str</span><span class="p">]</span>
        <span class="p">]</span>
        
        
        <span class="c1"># Distribuir proporcionalmente: Fecha/Hora más ancha, otras iguales</span>
        <span class="n">main_colWidths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.4</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="mf">1.15</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="mf">1.15</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="mf">1.15</span><span class="o">*</span><span class="n">inch</span><span class="p">]</span>  <span class="c1"># Total: 5.85 inches (ligeramente aumentado)</span>
        <span class="n">main_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">main_data</span><span class="p">,</span> <span class="n">colWidths</span><span class="o">=</span><span class="n">main_colWidths</span><span class="p">)</span>
        <span class="n">main_table</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">TableStyle</span><span class="p">([</span>
            <span class="c1"># Estilo del encabezado</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">grey</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TEXTCOLOR&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">whitesmoke</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">8</span><span class="p">),</span>
            <span class="c1"># Estilo de la fila de datos</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">lightblue</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">11</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="c1"># Alineación y bordes</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;CENTER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>
        <span class="p">]))</span>
        
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_table</span><span class="p">)</span>
        
        <span class="c1"># Tabla de detalles completos de la transacción</span>
        <span class="n">details_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;Detalles Completos de la Transacción&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;Usuario&#39;</span><span class="p">,</span> <span class="n">usuario_str</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;Segmento Cliente&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">get_segmento_display</span><span class="p">()],</span>
            <span class="p">[</span><span class="s1">&#39;Tipo de Transacción&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;Medio de Pago&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;Medio de Cobro&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span><span class="p">]</span>
        <span class="p">]</span>
        
        <span class="c1"># Detalles específicos por tipo de transacción</span>
        <span class="n">monto_original_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto_original</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">monto_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">redondeo_monto_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_monto</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">[</span><span class="s1">&#39;Monto ingresado para compra&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_original_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Redondeo por medio cobro Efectivo&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">redondeo_monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Monto a comprar&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Cotización para compra&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Precio base para compra&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">[</span><span class="s1">&#39;Monto ingresado para venta&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_original_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Monto a vender&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Cotización para venta&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Precio base para venta&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="p">])</span>
            
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">:</span>
                <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Redondeo por medio pago Efectivo&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">redondeo_monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        <span class="c1"># Beneficios y recargos</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Beneficio por segmento&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        
        <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Recargo por medio de pago (</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_pago</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_pago</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span><span class="p">:</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Recargo por medio de cobro (</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_cobro</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_cobro</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        <span class="c1"># Redondeo efectivo para precio final si aplica</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">)):</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Redondeo efectivo precio final&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        <span class="c1"># Montos finales</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
            <span class="n">estado_texto</span> <span class="o">=</span> <span class="s1">&#39;pagado&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Completa&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;a pagar&#39;</span>
            <span class="n">recibido_texto</span> <span class="o">=</span> <span class="s1">&#39;recibido&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;Completa&#39;</span> <span class="k">else</span> <span class="s1">&#39;a recibir&#39;</span>
            
            <span class="n">details_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Monto </span><span class="si">{</span><span class="n">estado_texto</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Monto </span><span class="si">{</span><span class="n">recibido_texto</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estado_texto</span> <span class="o">=</span> <span class="s1">&#39;pagado&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Completa&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;a pagar&#39;</span>
            <span class="n">recibido_texto</span> <span class="o">=</span> <span class="s1">&#39;recibido&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;Completa&#39;</span> <span class="k">else</span> <span class="s1">&#39;a recibir&#39;</span>
            
            <span class="n">details_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Monto </span><span class="si">{</span><span class="n">estado_texto</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Monto </span><span class="si">{</span><span class="n">recibido_texto</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="p">])</span>
        
        <span class="c1"># Mostrar monto pagado si es parcial</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span> <span class="o">&lt;</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="s1">&#39;Completa&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span> <span class="o">&lt;</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="s1">&#39;Completa&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
                <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Monto pagado&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Monto pagado&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        
        <span class="c1"># Token si existe y está pendiente/confirmada</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]:</span>
            <span class="n">details_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Código de transacción&#39;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span><span class="p">])</span>
        
        <span class="n">details_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">details_data</span><span class="p">,</span> <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">2.4</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="mf">3.45</span><span class="o">*</span><span class="n">inch</span><span class="p">])</span>  <span class="c1"># Ligeramente aumentado</span>
        <span class="n">details_table</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">TableStyle</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">darkgrey</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TEXTCOLOR&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">whitesmoke</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">11</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SPAN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;CENTER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">lightgrey</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;RIGHT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">.</span><span class="n">black</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;LEFTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># Ligeramente aumentado</span>
            <span class="p">(</span><span class="s1">&#39;RIGHTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1"># Ligeramente aumentado</span>
        <span class="p">]))</span>
        
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">details_table</span><span class="p">)</span>
        <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>  <span class="c1"># Espacio ligeramente mayor al final</span>
    
    <span class="c1"># Construir el PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
    
    <span class="c1"># Preparar la respuesta</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;historial_transacciones_</span><span class="si">{</span><span class="n">cliente</span><span class="o">.</span><span class="n">nombre</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    
    <span class="k">return</span> <span class="n">response</span></div>



<div class="viewcode-block" id="descargar_historial_excel">
<a class="viewcode-back" href="../../transacciones.html#transacciones.views.descargar_historial_excel">[documentos]</a>
<span class="nd">@login_required</span>  
<span class="k">def</span><span class="w"> </span><span class="nf">descargar_historial_excel</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para descargar el historial de transacciones en formato Excel.</span>
<span class="sd">    </span>
<span class="sd">    Genera un archivo Excel (.xlsx) con formato profesional que incluye títulos </span>
<span class="sd">    corporativos, filtros aplicados y detalles expandidos de cada transacción </span>
<span class="sd">    con encabezados individuales para mejor organización.</span>
<span class="sd">    </span>
<span class="sd">    Características del Excel generado:</span>
<span class="sd">        - Hoja única con todas las transacciones organizadas secuencialmente</span>
<span class="sd">        - Títulos corporativos y filtros aplicados al inicio</span>
<span class="sd">        - Cada transacción tiene su propio encabezado con información principal</span>
<span class="sd">        - Detalles expandidos con todos los cálculos y montos de cada operación</span>
<span class="sd">        - Formato profesional con colores, fuentes en negrita y alineación</span>
<span class="sd">        - Anchos de columna optimizados para legibilidad</span>
<span class="sd">        - Bordes y estilos aplicados consistentemente</span>
<span class="sd">    </span>
<span class="sd">    Filtros soportados:</span>
<span class="sd">        - cliente: ID del cliente específico (requerido)</span>
<span class="sd">        - busqueda: Búsqueda por nombre/documento de cliente o username de usuario</span>
<span class="sd">        - tipo_operacion: Filtro por tipo (&#39;compra&#39; o &#39;venta&#39;)</span>
<span class="sd">        - estado: Filtro por estado de transacción</span>
<span class="sd">        - usuario: ID del usuario que procesó la transacción</span>
<span class="sd">    </span>
<span class="sd">    Seguridad:</span>
<span class="sd">        - Verifica permisos del usuario para acceder al cliente solicitado</span>
<span class="sd">        - Valida existencia del cliente antes de procesar</span>
<span class="sd">        - Aplica los mismos filtros de seguridad que la vista de historial</span>
<span class="sd">    </span>
<span class="sd">    Estructura del Excel:</span>
<span class="sd">        - Fila 1-3: Título &quot;Global Exchange&quot; y &quot;Historial de Transacciones&quot;</span>
<span class="sd">        - Fila 4+: Filtros aplicados (si existen)</span>
<span class="sd">        - Por cada transacción:</span>
<span class="sd">            * Encabezado con datos principales (fecha, operación, moneda, estado)</span>
<span class="sd">            * Detalle expandido con todos los cálculos, medios de pago/cobro</span>
<span class="sd">            * Montos finales y información de pagos parciales</span>
<span class="sd">            * Código de transacción si aplica</span>
<span class="sd">    </span>
<span class="sd">    Formato y Estilos:</span>
<span class="sd">        - Encabezados en negrita con fondo gris</span>
<span class="sd">        - Datos alineados apropiadamente (centro, izquierda, derecha)</span>
<span class="sd">        - Bordes en todas las celdas para mejor visualización</span>
<span class="sd">        - Anchos de columna: [25, 18, 20, 15, 15] para óptima legibilidad</span>
<span class="sd">        - Formato de números con separadores de miles</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): Petición HTTP con parámetros de filtro en GET</span>
<span class="sd">            - cliente (str): ID del cliente (requerido)</span>
<span class="sd">            - busqueda (str, opcional): Término de búsqueda</span>
<span class="sd">            - tipo_operacion (str, opcional): &#39;compra&#39; o &#39;venta&#39;</span>
<span class="sd">            - estado (str, opcional): Estado de la transacción</span>
<span class="sd">            - usuario (str, opcional): ID del usuario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Archivo Excel para descarga con content-type &#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span>
<span class="sd">            - Nombre del archivo: &#39;historial_transacciones_{cliente_nombre}.xlsx&#39;</span>
<span class="sd">            - Headers configurados para descarga automática</span>
<span class="sd">            </span>
<span class="sd">    Raises:</span>
<span class="sd">        HttpResponse(400): Si no se proporciona ID de cliente</span>
<span class="sd">        HttpResponse(404): Si el cliente no existe</span>
<span class="sd">        redirect(&#39;inicio&#39;): Si el usuario no tiene permisos para el cliente</span>
<span class="sd">    </span>
<span class="sd">    Dependencias:</span>
<span class="sd">        - OpenPyXL: Para generación de archivos Excel (Workbook, estilos, etc.)</span>
<span class="sd">        - Django timezone: Para formateo de fechas consistente</span>
<span class="sd">        - Modelos: Cliente, Transaccion, Usuario</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">openpyxl</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">Font</span><span class="p">,</span> <span class="n">PatternFill</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">,</span> <span class="n">Border</span><span class="p">,</span> <span class="n">Side</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
    
    <span class="c1"># Obtener parámetros de filtro</span>
    <span class="n">cliente_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">)</span>
    <span class="n">busqueda</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;busqueda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">tipo_operacion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_operacion&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">estado_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estado&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">usuario_filtro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usuario&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Obtener transacciones con los mismos filtros que la vista principal</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cliente_id</span><span class="p">:</span>
            <span class="n">cliente</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente_id</span><span class="p">)</span>
            <span class="n">transacciones</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cliente</span><span class="o">=</span><span class="n">cliente</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-fecha_hora&#39;</span><span class="p">)</span>
            
            <span class="c1"># Verificar permisos del usuario</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">clientes_operados</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cliente</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No tienes permiso para descargar el historial de este cliente.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;inicio&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Cliente no especificado&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Cliente no encontrado&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
    
    <span class="c1"># Aplicar los mismos filtros que en la vista de historial</span>
    <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__nombre__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span> 
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__numero_documento__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">cliente__usuarios__username__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">tipo_operacion</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo</span><span class="o">=</span><span class="n">tipo_operacion</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">estado_filtro</span><span class="p">:</span>
        <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado__iexact</span><span class="o">=</span><span class="n">estado_filtro</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">usuario_filtro</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">usuario_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">usuario_filtro</span><span class="p">)</span>
            <span class="n">transacciones</span> <span class="o">=</span> <span class="n">transacciones</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario_id</span><span class="o">=</span><span class="n">usuario_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
    
    <span class="c1"># Crear el libro de Excel</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Historial de Transacciones&quot;</span>
    
    <span class="c1"># Estilos</span>
    <span class="n">header_font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;FFFFFF&quot;</span><span class="p">)</span>
    <span class="n">header_fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="n">start_color</span><span class="o">=</span><span class="s2">&quot;366092&quot;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s2">&quot;366092&quot;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
    <span class="n">header_alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">border</span> <span class="o">=</span> <span class="n">Border</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span> 
        <span class="n">top</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
        <span class="n">bottom</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    
    
    <span class="c1"># Título de la empresa (fila 1)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="s1">&#39;A1:E1&#39;</span><span class="p">)</span> 
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Global Exchange&quot;</span>
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Título del historial (fila 2)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="s1">&#39;A2:E2&#39;</span><span class="p">)</span>
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Historial de Transacciones - </span><span class="si">{</span><span class="n">cliente</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ws</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Información de filtros (si aplica)</span>
    <span class="n">row_start</span> <span class="o">=</span> <span class="mi">4</span>  
    <span class="k">if</span> <span class="n">busqueda</span> <span class="ow">or</span> <span class="n">tipo_operacion</span> <span class="ow">or</span> <span class="n">estado_filtro</span> <span class="ow">or</span> <span class="n">usuario_filtro</span><span class="p">:</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Comenzar en la fila 3 después de los títulos</span>
        
        <span class="c1"># Título de filtros</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">:E</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Ahora son 5 columnas</span>
        <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Filtros aplicados:&quot;</span>
        <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Filtros individuales por fila</span>
        <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">:E</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;• Búsqueda: &#39;</span><span class="si">{</span><span class="n">busqueda</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tipo_operacion</span><span class="p">:</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">:E</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;• Tipo de operación: </span><span class="si">{</span><span class="n">tipo_operacion</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">estado_filtro</span><span class="p">:</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">:E</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;• Estado: </span><span class="si">{</span><span class="n">estado_filtro</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">usuario_filtro</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">usuarios.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Usuario</span>
                <span class="n">usuario</span> <span class="o">=</span> <span class="n">Usuario</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">usuario_filtro</span><span class="p">)</span>
                <span class="n">ws</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">:E</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Ahora son 5 columnas</span>
                <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;• Usuario: </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">nombre_completo</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">usuario</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ws</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">current_row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="n">row_start</span> <span class="o">=</span> <span class="n">current_row</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="c1"># Datos de las transacciones con detalles - cada una con su propio encabezado</span>
    <span class="n">current_row</span> <span class="o">=</span> <span class="n">row_start</span>
    
    <span class="k">for</span> <span class="n">transaccion</span> <span class="ow">in</span> <span class="n">transacciones</span><span class="p">:</span>
        <span class="c1"># Agregar encabezado para cada transacción</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fecha&#39;</span><span class="p">,</span> <span class="s1">&#39;Hora&#39;</span><span class="p">,</span> <span class="s1">&#39;Operación&#39;</span><span class="p">,</span> <span class="s1">&#39;Moneda&#39;</span><span class="p">,</span> <span class="s1">&#39;Estado&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">current_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">col_num</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">header</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">header_alignment</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="n">border</span>
        
        <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Fila principal de la transacción - sin columna Usuario y Moneda solo símbolo</span>
        <span class="c1"># Usar timezone local como en el template HTML</span>
        <span class="n">fecha_hora_local</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">fecha_hora</span><span class="p">)</span>
        <span class="n">data_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fecha_hora_local</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">),</span>
            <span class="n">fecha_hora_local</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">),</span>
            <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
            <span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="p">,</span>  
            <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span>
        <span class="p">]</span>
        
        <span class="c1"># Aplicar estilo mejorado a la fila principal</span>
        <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">current_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">col_num</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="n">border</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="n">start_color</span><span class="o">=</span><span class="s2">&quot;E6F3FF&quot;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s2">&quot;E6F3FF&quot;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Filas de detalles completos de la transacción</span>
        <span class="n">detail_fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="n">start_color</span><span class="o">=</span><span class="s2">&quot;F5F5F5&quot;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s2">&quot;F5F5F5&quot;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
        <span class="n">detail_font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">italic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">add_detail_row</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper para agregar filas de detalle con formato mejorado&quot;&quot;&quot;</span>
            <span class="c1"># Celda de etiqueta</span>
            <span class="n">label_cell</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">current_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">label_cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">label_cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">label_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">detail_fill</span>
            <span class="n">label_cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">label_cell</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="n">Border</span><span class="p">(</span>
                <span class="n">left</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">right</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">top</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">bottom</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Celda de valor</span>
            <span class="n">value_cell</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">current_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">value_cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">value_cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">detail_font</span>
            <span class="n">value_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="n">start_color</span><span class="o">=</span><span class="s2">&quot;FFFFFF&quot;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s2">&quot;FFFFFF&quot;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
            <span class="n">value_cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">value_cell</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="n">Border</span><span class="p">(</span>
                <span class="n">left</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">right</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">top</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">),</span>
                <span class="n">bottom</span><span class="o">=</span><span class="n">Side</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;thin&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">current_row</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Información básica</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Usuario:&quot;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">usuario</span><span class="o">.</span><span class="n">nombre_completo</span><span class="p">()</span> <span class="ow">or</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">usuario</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Segmento Cliente:&quot;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">get_segmento_display</span><span class="p">())</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Tipo de Transacción:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Medio de Pago:&quot;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span><span class="p">)</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Medio de Cobro:&quot;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span><span class="p">)</span>
        
        <span class="c1"># Detalles específicos por tipo de transacción</span>
        <span class="n">monto_original_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto_original</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">monto_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">redondeo_monto_formateado</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_monto</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto ingresado para compra:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_original_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Redondeo por medio cobro Efectivo:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">redondeo_monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto a comprar:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Cotización para compra:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Precio base para compra:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto ingresado para venta:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_original_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto a vender:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Cotización para venta:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cotizacion</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Precio base para venta:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_base</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">:</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Redondeo por medio pago Efectivo:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">redondeo_monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Beneficios y recargos</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Beneficio por segmento:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">beneficio_segmento</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        
        <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recargo por medio de pago (</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_pago</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_pago</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span><span class="p">:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recargo por medio de cobro (</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">porc_recargo_cobro</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">recargo_cobro</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Redondeo efectivo para precio final si aplica</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_pago</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">medio_cobro</span> <span class="o">==</span> <span class="s1">&#39;Efectivo&#39;</span><span class="p">)):</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Redondeo efectivo precio final:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">redondeo_efectivo_precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Montos finales</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
            <span class="n">estado_texto</span> <span class="o">=</span> <span class="s1">&#39;pagado&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Completa&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;a pagar&#39;</span>
            <span class="n">recibido_texto</span> <span class="o">=</span> <span class="s1">&#39;recibido&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;Completa&#39;</span> <span class="k">else</span> <span class="s1">&#39;a recibir&#39;</span>
            
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monto </span><span class="si">{</span><span class="n">estado_texto</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monto </span><span class="si">{</span><span class="n">recibido_texto</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estado_texto</span> <span class="o">=</span> <span class="s1">&#39;pagado&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Completa&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;a pagar&#39;</span>
            <span class="n">recibido_texto</span> <span class="o">=</span> <span class="s1">&#39;recibido&#39;</span> <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="s1">&#39;Completa&#39;</span> <span class="k">else</span> <span class="s1">&#39;a recibir&#39;</span>
            
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monto </span><span class="si">{</span><span class="n">estado_texto</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monto_formateado</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monto </span><span class="si">{</span><span class="n">recibido_texto</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Mostrar monto pagado si es parcial</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span> <span class="o">&lt;</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">precio_final</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="s1">&#39;Completa&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;venta&#39;</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span> <span class="o">&lt;</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">monto</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="s1">&#39;Completa&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;compra&#39;</span><span class="p">:</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto pagado:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gs. </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Monto pagado:&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">pagado</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">decimales</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">transaccion</span><span class="o">.</span><span class="n">moneda</span><span class="o">.</span><span class="n">simbolo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Token si existe y está pendiente/confirmada</span>
        <span class="k">if</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span> <span class="ow">and</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pendiente&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmada&#39;</span><span class="p">]:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="n">add_detail_row</span><span class="p">(</span><span class="s2">&quot;Código de transacción:&quot;</span><span class="p">,</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        
        <span class="c1"># Fila de separación entre transacciones</span>
        <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Ajustar ancho de columnas para que coincidan proporcionalmente con detalles</span>
    <span class="c1"># Proporcionalmente similar a PDF: más ancho para fecha, iguales para el resto</span>
    <span class="n">column_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>  <span class="c1"># Fecha, Hora, Operación, Moneda, Estado</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_widths</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">column_dimensions</span><span class="p">[</span><span class="n">openpyxl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_column_letter</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
    
    <span class="c1"># Ajustar altura de filas para mejor legibilidad</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ws</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">():</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">row_dimensions</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">20</span>
    
    <span class="c1"># Guardar en buffer</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Preparar la respuesta</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span>
    <span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;historial_transacciones_</span><span class="si">{</span><span class="n">cliente</span><span class="o">.</span><span class="n">nombre</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    
    <span class="k">return</span> <span class="n">response</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2025, Grupo 1.
      <span class="lastupdated">Actualizado por última vez en True.
      </span></p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>