

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transacciones.utils_2fa &mdash; documentación de Global Exchange - Versión 2</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=3e28a9e4"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=f85f4cfb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Global Exchange
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../clientes.html">Clientes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usuarios.html">Usuarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roles.html">Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monedas.html">Monedas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transacciones.html">Transacciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../medios_acreditacion.html">Medios de Acreditación</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../proyecto.html">Directorio principal del Proyecto</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Global Exchange</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Código de módulo</a></li>
      <li class="breadcrumb-item active">transacciones.utils_2fa</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Código fuente para transacciones.utils_2fa</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilidades para autenticación de dos factores (2FA) en transacciones.</span>

<span class="sd">Este módulo contiene todas las funciones necesarias para implementar</span>
<span class="sd">el sistema de autenticación de dos factores para transacciones,</span>
<span class="sd">incluyendo generación de tokens, envío de emails y validaciones.</span>

<span class="sd">Funcionalidades principales:</span>
<span class="sd">    - Verificación de estado de 2FA en el sistema</span>
<span class="sd">    - Generación de tokens aleatorios de 6 dígitos</span>
<span class="sd">    - Envío de tokens por email</span>
<span class="sd">    - Validación de tokens ingresados por usuarios</span>
<span class="sd">    - Gestión del ciclo de vida de tokens (creación, validación, expiración)</span>
<span class="sd">    - Limpieza de tokens expirados</span>

<span class="sd">Configuración requerida en settings.py:</span>
<span class="sd">    ENABLE_2FA_TRANSACTIONS: bool - Habilita/deshabilita el sistema 2FA</span>
<span class="sd">    TWO_FACTOR_AUTH: dict - Configuración de parámetros del sistema 2FA</span>
<span class="sd">        - TOKEN_LENGTH: int - Longitud del token (default: 6)</span>
<span class="sd">        - TOKEN_EXPIRY_MINUTES: int - Minutos de validez del token (default: 1)</span>
<span class="sd">        - EMAIL_SUBJECT: str - Asunto del email</span>
<span class="sd">        - EMAIL_FROM: str - Email remitente</span>

<span class="sd">Author: Sistema de Desarrollo Global Exchange</span>
<span class="sd">Date: 2025</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_mail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.html</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_tags</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransactionToken</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="is_2fa_enabled">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.is_2fa_enabled">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_2fa_enabled</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si el 2FA está habilitado globalmente en el sistema.</span>
<span class="sd">    </span>
<span class="sd">    Esta función consulta la configuración del sistema para determinar</span>
<span class="sd">    si la autenticación de dos factores está activa para las transacciones.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el 2FA está habilitado, False en caso contrario</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; if is_2fa_enabled():</span>
<span class="sd">        ...     send_2fa_token(user)</span>
<span class="sd">        ... else:</span>
<span class="sd">        ...     process_transaction_directly()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;ENABLE_2FA_TRANSACTIONS&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_2fa_token">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.generate_2fa_token">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_2fa_token</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera un token aleatorio de dígitos numéricos.</span>
<span class="sd">    </span>
<span class="sd">    Utiliza la configuración TOKEN_LENGTH del sistema para determinar</span>
<span class="sd">    la longitud del token. Por defecto genera 6 dígitos.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Token numérico aleatorio</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; token = generate_2fa_token()</span>
<span class="sd">        &gt;&gt;&gt; len(token)</span>
<span class="sd">        6</span>
<span class="sd">        &gt;&gt;&gt; token.isdigit()</span>
<span class="sd">        True</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        El token generado es aleatorio y no se garantiza que sea único</span>
<span class="sd">        sin validación adicional contra la base de datos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">token_length</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TWO_FACTOR_AUTH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TOKEN_LENGTH&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">token_length</span><span class="p">))</span></div>


<div class="viewcode-block" id="send_2fa_email">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.send_2fa_email">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_2fa_email</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un email con el token 2FA al usuario.</span>
<span class="sd">    </span>
<span class="sd">    Renderiza un template HTML con el token y lo envía al email del usuario.</span>
<span class="sd">    También genera una versión de texto plano como fallback.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        usuario (Usuario): Usuario al que enviar el token. Debe tener un email válido.</span>
<span class="sd">        token (str): Token numérico a enviar al usuario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el email se envió correctamente, False en caso contrario</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        No lanza excepciones, las captura y registra en el log.</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; user = User.objects.get(username=&#39;test_user&#39;)</span>
<span class="sd">        &gt;&gt;&gt; token = &#39;123456&#39;</span>
<span class="sd">        &gt;&gt;&gt; success = send_2fa_email(user, token)</span>
<span class="sd">        &gt;&gt;&gt; if success:</span>
<span class="sd">        ...     print(&quot;Email enviado correctamente&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        - Requiere configuración SMTP válida en settings.py</span>
<span class="sd">        - Utiliza el template &#39;transacciones/emails/2fa_token.html&#39;</span>
<span class="sd">        - Registra el resultado en el logger del módulo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Configuración del email</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TWO_FACTOR_AUTH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EMAIL_SUBJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;Código de verificación&#39;</span><span class="p">)</span>
        <span class="n">from_email</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TWO_FACTOR_AUTH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EMAIL_FROM&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">EMAIL_HOST_USER</span><span class="p">)</span>
        <span class="n">recipient_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">usuario</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>
        
        <span class="c1"># Contexto para el template del email</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;usuario&#39;</span><span class="p">:</span> <span class="n">usuario</span><span class="p">,</span>
            <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
            <span class="s1">&#39;expiry_minutes&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">TWO_FACTOR_AUTH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TOKEN_EXPIRY_MINUTES&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Renderizar el template HTML del email</span>
        <span class="n">html_message</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;transacciones/emails/2fa_token.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">plain_message</span> <span class="o">=</span> <span class="n">strip_tags</span><span class="p">(</span><span class="n">html_message</span><span class="p">)</span>
        
        <span class="c1"># Enviar el email</span>
        <span class="n">send_mail</span><span class="p">(</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">plain_message</span><span class="p">,</span>
            <span class="n">from_email</span><span class="o">=</span><span class="n">from_email</span><span class="p">,</span>
            <span class="n">recipient_list</span><span class="o">=</span><span class="n">recipient_list</span><span class="p">,</span>
            <span class="n">html_message</span><span class="o">=</span><span class="n">html_message</span><span class="p">,</span>
            <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token 2FA enviado exitosamente a </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al enviar token 2FA a </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="create_transaction_token">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.create_transaction_token">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_transaction_token</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">transaccion_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crea un token de transacción y envía el email de verificación.</span>
<span class="sd">    </span>
<span class="sd">    Esta es la función principal para iniciar el flujo 2FA. Genera un token,</span>
<span class="sd">    lo almacena en la base de datos asociado a los datos de la transacción,</span>
<span class="sd">    y envía el token al usuario por email.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        usuario (Usuario): Usuario para el que crear el token</span>
<span class="sd">        transaccion_data (dict): Datos de la transacción a almacenar. Debe contener:</span>
<span class="sd">            - transaccion_id: int - ID de la transacción</span>
<span class="sd">            - cliente_id: int - ID del cliente</span>
<span class="sd">            - tipo: str - Tipo de transacción (&#39;compra&#39; o &#39;venta&#39;)</span>
<span class="sd">            - monto: str - Monto de la transacción</span>
<span class="sd">            - moneda_id: int - ID de la moneda</span>
<span class="sd">            - precio_final: Decimal - Precio final calculado</span>
<span class="sd">            - medio_pago: str - Medio de pago seleccionado (opcional)</span>
<span class="sd">            - medio_cobro: str - Medio de cobro seleccionado (opcional)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Diccionario con el resultado de la operación:</span>
<span class="sd">            - success (bool): True si se creó y envió correctamente</span>
<span class="sd">            - message (str): Mensaje descriptivo del resultado</span>
<span class="sd">            - token_id (int): ID del token creado (solo si success=True)</span>
<span class="sd">            - expires_at (datetime): Fecha de expiración (solo si success=True)</span>
<span class="sd">            - error (str): Código de error (solo si success=False)</span>
<span class="sd">            </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; transaccion_data = {</span>
<span class="sd">        ...     &#39;transaccion_id&#39;: 123,</span>
<span class="sd">        ...     &#39;cliente_id&#39;: 45,</span>
<span class="sd">        ...     &#39;tipo&#39;: &#39;compra&#39;,</span>
<span class="sd">        ...     &#39;monto&#39;: &#39;100.00&#39;,</span>
<span class="sd">        ...     &#39;moneda_id&#39;: 1,</span>
<span class="sd">        ...     &#39;precio_final&#39;: 700000</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; result = create_transaction_token(user, transaccion_data)</span>
<span class="sd">        &gt;&gt;&gt; if result[&#39;success&#39;]:</span>
<span class="sd">        ...     print(f&quot;Token enviado, expira: {result[&#39;expires_at&#39;]}&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        - Si el envío del email falla, el token se elimina automáticamente</span>
<span class="sd">        - El token tiene una duración limitada según TOKEN_EXPIRY_MINUTES</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Generar el token usando el modelo</span>
        <span class="n">token_obj</span> <span class="o">=</span> <span class="n">TransactionToken</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">transaccion_data</span><span class="p">)</span>
        
        <span class="c1"># Enviar email con el token</span>
        <span class="n">email_sent</span> <span class="o">=</span> <span class="n">send_2fa_email</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">email_sent</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Token de verificación enviado a </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;token_id&#39;</span><span class="p">:</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">expires_at</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Si falla el envío del email, eliminar el token</span>
            <span class="n">token_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error al enviar el email de verificación&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;EMAIL_SEND_FAILED&#39;</span>
            <span class="p">}</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al crear token de transacción: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error interno al generar token de verificación&#39;</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="validate_2fa_token">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.validate_2fa_token">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_2fa_token</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">token_input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Valida un token 2FA ingresado por el usuario.</span>
<span class="sd">    </span>
<span class="sd">    Busca el token más reciente no usado del usuario, verifica que no haya</span>
<span class="sd">    expirado y que coincida con el token ingresado. Si es válido, marca el</span>
<span class="sd">    token como usado y devuelve los datos de la transacción asociada.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        usuario (Usuario): Usuario que intenta validar el token</span>
<span class="sd">        token_input (str): Token numérico ingresado por el usuario</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Diccionario con el resultado de la validación:</span>
<span class="sd">            - success (bool): True si el token es válido</span>
<span class="sd">            - message (str): Mensaje descriptivo del resultado</span>
<span class="sd">            - transaccion_data (dict): Datos de la transacción (solo si success=True)</span>
<span class="sd">            - error (str): Código de error (solo si success=False)</span>
<span class="sd">            </span>
<span class="sd">    Posibles errores:</span>
<span class="sd">        - NO_TOKEN_FOUND: No hay token pendiente para el usuario</span>
<span class="sd">        - TOKEN_EXPIRED: El token ha expirado</span>
<span class="sd">        - INVALID_TOKEN: El token ingresado no coincide</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; result = validate_2fa_token(user, &#39;123456&#39;)</span>
<span class="sd">        &gt;&gt;&gt; if result[&#39;success&#39;]:</span>
<span class="sd">        ...     transaccion_data = result[&#39;transaccion_data&#39;]</span>
<span class="sd">        ...     process_transaction(transaccion_data)</span>
<span class="sd">        ... else:</span>
<span class="sd">        ...     print(f&quot;Error: {result[&#39;message&#39;]}&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        - Los tokens expirados se eliminan automáticamente al ser detectados</span>
<span class="sd">        - Un token solo puede usarse una vez</span>
<span class="sd">        - Busca solo entre tokens no usados del usuario</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Buscar el token más reciente no usado del usuario</span>
        <span class="n">token_obj</span> <span class="o">=</span> <span class="n">TransactionToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">usuario</span><span class="o">=</span><span class="n">usuario</span><span class="p">,</span>
            <span class="n">used</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_at&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No hay token de verificación pendiente&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;NO_TOKEN_FOUND&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Verificar si el token ha expirado</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">token_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># Limpiar token expirado</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;El token de verificación ha expirado&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;TOKEN_EXPIRED&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Verificar si el token coincide</span>
        <span class="k">if</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">token</span> <span class="o">!=</span> <span class="n">token_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Token de verificación incorrecto&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;INVALID_TOKEN&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Token válido - marcarlo como usado y devolver datos de transacción</span>
        <span class="n">transaccion_data</span> <span class="o">=</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">transaccion_data</span>
        <span class="n">token_obj</span><span class="o">.</span><span class="n">mark_as_used</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token 2FA validado exitosamente para usuario </span><span class="si">{</span><span class="n">usuario</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Token verificado correctamente&#39;</span><span class="p">,</span>
            <span class="s1">&#39;transaccion_data&#39;</span><span class="p">:</span> <span class="n">transaccion_data</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al validar token 2FA: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error interno al validar token&#39;</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="cleanup_expired_tokens">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.cleanup_expired_tokens">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired_tokens</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limpia tokens expirados de la base de datos.</span>
<span class="sd">    </span>
<span class="sd">    Elimina todos los tokens cuya fecha de expiración sea anterior al momento</span>
<span class="sd">    actual. Esta función es útil para mantener la base de datos limpia y</span>
<span class="sd">    mejorar el rendimiento.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        int: Número de tokens eliminados</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; deleted_count = cleanup_expired_tokens()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Se eliminaron {deleted_count} tokens expirados&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        - Esta función debería ejecutarse periódicamente (cron job, celery task, etc.)</span>
<span class="sd">        - No afecta a tokens válidos aún no expirados</span>
<span class="sd">        - Registra el resultado en el logger del módulo</span>
<span class="sd">        - Es seguro ejecutarla múltiples veces</span>
<span class="sd">        </span>
<span class="sd">    Suggested Usage:</span>
<span class="sd">        Configurar como tarea periódica en celery:</span>
<span class="sd">        </span>
<span class="sd">        @periodic_task(run_every=timedelta(hours=1))</span>
<span class="sd">        def cleanup_tokens():</span>
<span class="sd">            from transacciones.utils_2fa import cleanup_expired_tokens</span>
<span class="sd">            cleanup_expired_tokens()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expired_count</span> <span class="o">=</span> <span class="n">TransactionToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">expires_at__lt</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">expired_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eliminados </span><span class="si">{</span><span class="n">expired_count</span><span class="si">}</span><span class="s2"> tokens expirados&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">expired_count</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al limpiar tokens expirados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_token_status">
<a class="viewcode-back" href="../../transacciones.html#transacciones.utils_2fa.get_token_status">[documentos]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_token_status</span><span class="p">(</span><span class="n">usuario</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado del token actual del usuario.</span>
<span class="sd">    </span>
<span class="sd">    Consulta el token más reciente no usado del usuario y devuelve información</span>
<span class="sd">    detallada sobre su estado (si existe, si es válido, tiempo restante, etc.).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        usuario (Usuario): Usuario para verificar el estado del token</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Diccionario con información del estado del token:</span>
<span class="sd">            - exists (bool): True si existe un token pendiente</span>
<span class="sd">            - valid (bool): True si el token es válido (no expirado)</span>
<span class="sd">            - expires_at (datetime): Fecha de expiración (solo si exists=True)</span>
<span class="sd">            - created_at (datetime): Fecha de creación (solo si exists=True)</span>
<span class="sd">            - time_remaining (float): Segundos restantes hasta expiración (solo si valid=True)</span>
<span class="sd">            - message (str): Mensaje descriptivo del estado</span>
<span class="sd">            </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; status = get_token_status(user)</span>
<span class="sd">        &gt;&gt;&gt; if status[&#39;valid&#39;]:</span>
<span class="sd">        ...     remaining = status[&#39;time_remaining&#39;]</span>
<span class="sd">        ...     print(f&quot;Token válido por {remaining} segundos más&quot;)</span>
<span class="sd">        ... else:</span>
<span class="sd">        ...     print(status[&#39;message&#39;])</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        - Útil para mostrar información en el frontend (temporizador, etc.)</span>
<span class="sd">        - No modifica el estado del token</span>
<span class="sd">        - Siempre busca el token más reciente no usado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token_obj</span> <span class="o">=</span> <span class="n">TransactionToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">usuario</span><span class="o">=</span><span class="n">usuario</span><span class="p">,</span>
            <span class="n">used</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_at&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No hay token pendiente&#39;</span>
            <span class="p">}</span>
        
        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">is_valid</span><span class="p">,</span>
            <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">expires_at</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">token_obj</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
            <span class="s1">&#39;time_remaining&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">token_obj</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">-</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Token válido&#39;</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="s1">&#39;Token expirado&#39;</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al obtener estado del token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error al verificar estado del token&#39;</span>
        <span class="p">}</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2025, Grupo 1.
      <span class="lastupdated">Actualizado por última vez en True.
      </span></p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>