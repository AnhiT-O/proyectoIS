{% extends 'base.html' %}
{% load static %}

{% block title %}Agregar Tarjeta - {{ cliente.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'claro/formularios.css' %}" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="{% static 'oscuro/formularios.css' %}" media="(prefers-color-scheme: dark)">
{% endblock %}

{% block content %}
<div class="cuerpo">
    <div class="contenido extendido">
        <div class="form-cabecera">
            <div class="logo">ðŸ’³ Agregar Tarjeta de CrÃ©dito</div>
            <p class="subtitulo">Para {{ cliente.nombre }} {{ cliente.apellido }}</p>
            <p class="subtitulo">ðŸ”’ Datos procesados de forma segura con Stripe</p>
        </div>

        <form id="stripe-form">
            {% csrf_token %}
            
            <div id="form-messages" style="display: none;">
                <div id="error-message" style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                </div>
                <div id="success-message" style="background: #efe; border: 1px solid #cfc; color: #3c3; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                </div>
            </div>

            <div class="form-campo">
                <label for="descripcion_tarjeta">
                    DescripciÃ³n de la Tarjeta
                </label>
                <div>
                    <input 
                        type="text" 
                        id="descripcion_tarjeta" 
                        name="descripcion_tarjeta"
                        class="form-control"
                        placeholder="Ej: Tarjeta personal, Tarjeta de empresa"
                        required
                    >
                </div>
                <small style="color: #666; font-size: 0.85rem;">DescripciÃ³n breve para identificar esta tarjeta</small>
            </div>

            <div class="form-campo">
                <label for="moneda_tc">
                    Moneda de la Tarjeta
                </label>
                <div>
                    <select id="moneda_tc" name="moneda_tc" class="form-control" required>
                        <option value="">Seleccione una moneda</option>
                        <option value="PYG">GuaranÃ­es (PYG)</option>
                        <option value="USD">DÃ³lares (USD)</option>
                    </select>
                </div>
                <small style="color: #666; font-size: 0.85rem;">Moneda en la que opera la tarjeta</small>
            </div>

            <div class="form-campo">
                <label for="card-element">
                    Datos de la Tarjeta
                </label>
                <div id="card-element" class="form-control stripe-element">
                    <!-- Stripe Elements crearÃ¡ aquÃ­ el formulario de tarjeta -->
                </div>
                <div id="card-errors" role="alert"></div>
                <small style="color: #666; font-size: 0.85rem;">
                    ðŸ”’ Los datos de su tarjeta son procesados de forma segura por Stripe y nunca se almacenan en nuestros servidores
                </small>
            </div>

            <div class="zona-botones">
                <button type="submit" id="submit-button" class="btn-enviar">
                    <span id="button-text">Agregar Tarjeta</span>
                    <span id="spinner" style="display: none;">ðŸ”„ Procesando...</span>
                </button>
                <a href="{% url 'clientes:cliente_detalle' cliente.id %}" class="btn-atras">
                    Cancelar
                </a>
            </div>
        </form>

        <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="margin: 0 0 0.5rem 0; color: #667eea;">ðŸ’¡ InformaciÃ³n importante</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                <li>Sus datos bancarios son procesados de forma segura por Stripe</li>
                <li>No almacenamos informaciÃ³n sensible de su tarjeta</li>
                <li>Puede usar tarjetas de prueba para desarrollo: 4242424242424242</li>
                <li>Use cualquier fecha futura y CVV de 3 dÃ­gitos</li>
            </ul>
        </div>
    </div>
</div>

<style>
/* Estilos especÃ­ficos para los campos del formulario */
#descripcion_tarjeta, #moneda_tc {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    background-color: #fff;
}

#descripcion_tarjeta:focus, #moneda_tc:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Estilos para Stripe Elements */
.stripe-element {
    padding: 0.75rem 1rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    background-color: #fff;
    transition: border-color 0.3s ease;
    margin-bottom: 1rem;
}

.stripe-element--focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.stripe-element--invalid {
    border-color: #fa755a;
}

.stripe-element--complete {
    border-color: #50e3c2;
}

#card-errors {
    color: #fa755a;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Ocultar elementos de Link de Stripe */
.stripe-element iframe {
    /* Ocultar cualquier iframe que contenga el botÃ³n de Link */
}

/* Estilos para ocultar especÃ­ficamente el botÃ³n de Stripe Link */
#card-element button[data-testid*="link"],
#card-element div[data-testid*="link"],
#card-element .Link,
#card-element .LinkButton,
#card-element [class*="Link"],
#card-element [id*="link"],
#card-element [class*="link-button"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    overflow: hidden !important;
}

/* Ocultar cualquier elemento que contenga "Link" en el texto */
#card-element *:has-text("Link"),
#card-element *:has-text("Use Link") {
    display: none !important;
}
</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    // Crear elemento de tarjeta
    const cardElement = elements.create('card', {
        hidePostalCode: true,
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
            invalid: {
                color: '#9e2146',
            },
        },
        // Deshabilitar completamente Link
        link: {
            enabled: false
        },
        defaultValues: {
            link: null
        },
        disableLink: true
    });

    cardElement.mount('#card-element');

    // FunciÃ³n para ocultar elementos de Link despuÃ©s del montaje
    function hideStripeLink() {
        const cardContainer = document.getElementById('card-element');
        if (cardContainer) {
            // Buscar y ocultar elementos de Link
            const linkElements = cardContainer.querySelectorAll(
                'button[data-testid*="link"], ' +
                'div[data-testid*="link"], ' +
                '[class*="Link"], ' +
                '[class*="link-button"], ' +
                'button:contains("Link"), ' +
                'button:contains("Use Link")'
            );
            
            linkElements.forEach(element => {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
                element.style.opacity = '0';
                element.style.height = '0';
                element.style.width = '0';
                element.style.overflow = 'hidden';
            });

            // TambiÃ©n buscar en iframes
            const iframes = cardContainer.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        const linkElementsInIframe = iframeDoc.querySelectorAll(
                            'button[data-testid*="link"], ' +
                            '[class*="Link"], ' +
                            '[class*="link-button"]'
                        );
                        linkElementsInIframe.forEach(element => {
                            element.style.display = 'none';
                        });
                    }
                } catch (e) {
                    // Ignorar errores de cross-origin
                }
            });
        }
    }

    // Ejecutar despuÃ©s del montaje
    setTimeout(hideStripeLink, 100);
    setTimeout(hideStripeLink, 500);
    setTimeout(hideStripeLink, 1000);

    // Manejar errores en tiempo real
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
        
        // Ocultar Link despuÃ©s de cada cambio
        setTimeout(hideStripeLink, 50);
    });

    // Observador de mutaciones para detectar cambios en el DOM de Stripe
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                hideStripeLink();
            }
        });
    });

    // Observar cambios en el contenedor de la tarjeta
    const cardContainer = document.getElementById('card-element');
    if (cardContainer) {
        observer.observe(cardContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class', 'style']
        });
    }

    // Manejar envÃ­o del formulario
    const form = document.getElementById('stripe-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        setLoading(true);
        
        const descripcion = document.getElementById('descripcion_tarjeta').value;
        const moneda = document.getElementById('moneda_tc').value;
        
        if (!descripcion || !moneda) {
            showError('Por favor complete todos los campos');
            setLoading(false);
            return;
        }

        try {
            // Crear Setup Intent
            const setupIntentResponse = await fetch('{% url "medios_pago:crear_setup_intent" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    cliente_id: {{ cliente.id }}
                })
            });
            
            const setupIntentData = await setupIntentResponse.json();
            
            if (!setupIntentResponse.ok) {
                throw new Error(setupIntentData.error || 'Error al crear setup intent');
            }

            // Confirmar setup intent con Stripe
            const {error, setupIntent} = await stripe.confirmCardSetup(
                setupIntentData.client_secret,
                {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: '{{ cliente.nombre }} {{ cliente.apellido }}',
                        },
                    }
                }
            );

            if (error) {
                showError(error.message);
                setLoading(false);
            } else {
                // Ã‰xito - redirigir
                showSuccess('Tarjeta agregada exitosamente');
                setTimeout(() => {
                    window.location.href = '{% url "clientes:cliente_detalle" cliente.id %}';
                }, 2000);
            }
        } catch (error) {
            console.error('Error:', error);
            showError(error.message || 'Error al procesar la tarjeta');
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const form = document.getElementById('stripe-form');
        
        if (isLoading) {
            submitButton.disabled = true;
            buttonText.style.display = 'none';
            spinner.style.display = 'inline';
            form.classList.add('loading');
        } else {
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            form.classList.remove('loading');
        }
    }

    function showError(message) {
        const messagesDiv = document.getElementById('form-messages');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
        messagesDiv.style.display = 'block';
        
        // Scroll al mensaje de error
        messagesDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function showSuccess(message) {
        const messagesDiv = document.getElementById('form-messages');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        messagesDiv.style.display = 'block';
        
        // Scroll al mensaje de Ã©xito
        messagesDiv.scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}