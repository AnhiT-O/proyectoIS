{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if transaccion.tipo == 'venta' %}
        Vender Monedas - Confirmación - Global Exchange
    {% else %}
        Comprar Monedas - Confirmación - Global Exchange
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'claro/formularios.css' %}" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="{% static 'oscuro/formularios.css' %}" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="{% static 'claro/perfil.css' %}" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="{% static 'oscuro/perfil.css' %}" media="(prefers-color-scheme: dark)">
{% endblock %}

{% block content %}
<div class="contenido extendido">
    <!-- Barra de progreso -->
    <div class="barra-progreso-container">
        <div class="barra-progreso" data-progreso="{{ paso_actual }}">
            <div class="paso {% if paso_actual == 1 %}activo{% elif paso_actual > 1 %}completado{% endif %}">
                <div class="paso-numero">1</div>
                <div class="paso-titulo">Selección de<br>Moneda y Monto</div>
            </div>
            <div class="paso {% if paso_actual == 2 %}activo{% elif paso_actual > 2 %}completado{% endif %}">
                <div class="paso-numero">2</div>
                <div class="paso-titulo">Medio de<br>Pago</div>
            </div>
            <div class="paso {% if paso_actual == 3 %}activo{% elif paso_actual > 3 %}completado{% endif %}">
                <div class="paso-numero">3</div>
                <div class="paso-titulo">Medio de<br>Cobro</div>
            </div>
            <div class="paso {% if paso_actual == 4 %}activo{% elif paso_actual > 4 %}completado{% endif %}">
                <div class="paso-numero">4</div>
                <div class="paso-titulo">Confirmación de<br>
                    {% if transaccion.tipo == 'venta' %}Venta{% else %}Compra{% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="form-cabecera">
        <h2>{{ titulo_paso }}</h2>
        <div style="margin: 2rem;">
            <p class="subtitulo">
                Confirma que los datos están correctos antes de proceder con la {% if tipo_transaccion == 'venta' %}venta{% else %}compra{% endif %} de monedas.
            </p>
        </div>

        <!-- Información de la transacción -->
        <div class="info-transaccion">
            <h3>Resumen de la transacción</h3>
            <div class="detalles-transaccion">
                <div class="detalle-item">
                    <div class="detalle-titulo">Nombre del cliente:</div>
                    <div class="detalle-valor">{{ transaccion.cliente.nombre }}</div>
                </div>
                <div class="detalle-item">
                    <div class="detalle-titulo">Segmento del cliente:</div>
                    <div class="detalle-valor">{{ transaccion.cliente.get_segmento_display }}</div>
                </div>
                <div class="detalle-item">
                    <div class="detalle-titulo">Tipo de transacción:</div>
                    <div class="detalle-valor">
                        {% if transaccion.tipo == 'venta' %}
                            Venta de {{ transaccion.moneda.nombre }}
                        {% else %}
                            Compra de {{ transaccion.moneda.nombre }}
                        {% endif %}
                    </div>
                </div>
                <div class="detalle-item">
                    <div class="detalle-titulo">Medio de pago:</div>
                    <div class="detalle-valor">{{ transaccion.medio_pago }}</div>
                </div>
                <div class="detalle-item">
                    <div class="detalle-titulo">Medio de cobro:</div>
                    <div class="detalle-valor">{{ transaccion.medio_cobro }}</div>
                </div>
                {% if transaccion.tipo == 'compra' %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Monto ingresado para compra:</div>
                        <div class="detalle-valor">{{ transaccion.monto_original|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Redondeo por medio de cobro Efectivo:</div>
                        <div class="detalle-valor">{{ transaccion.redondeo_efectivo_monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Monto a comprar:</div>
                        <div class="detalle-valor">{{ transaccion.monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Cotización para compra:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.cotizacion|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Precio base para compra:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.precio_base|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Beneficio por segmento:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.beneficio_segmento|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Recargo por medio de pago ({{ transaccion.porc_recargo_pago }}):</div>
                        <div class="detalle-valor">Gs. {{ transaccion.recargo_pago|intcomma }}</div>
                    </div>
                    {% if transaccion.medio_pago == 'Efectivo' %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Redondeo por medio de pago Efectivo:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.redondeo_efectivo_precio_final|intcomma }}</div>
                    </div>
                    {% endif %}
                    <div class="detalle-item">
                        <div class="detalle-titulo" style="font-size:large">Monto a pagar:</div>
                        <div class="detalle-valor" style="font-size:large">Gs. {{ transaccion.precio_final|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo" style="font-size:large">Monto a recibir:</div>
                        <div class="detalle-valor" style="font-size:large">{{ transaccion.monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                {% else %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Monto ingresado para venta:</div>
                        <div class="detalle-valor">{{ transaccion.monto_original|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    {% if transaccion.medio_pago == 'Efectivo' %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Redondeo por medio de pago Efectivo:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.redondeo_efectivo_monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo" style="font-size:large">Monto a vender:</div>
                        <div class="detalle-valor" style="font-size:large">{{ transaccion.monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    {% endif %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Cotización para venta:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.cotizacion|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Precio base para venta:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.precio_base|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Beneficio por segmento:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.beneficio_segmento|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Recargo por medio de pago ({{ transaccion.porc_recargo_pago }}):</div>
                        <div class="detalle-valor">Gs. {{ transaccion.recargo_pago|intcomma }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo">Recargo por medio de cobro ({{ transaccion.porc_recargo_cobro }}):</div>
                        <div class="detalle-valor">Gs. {{ transaccion.recargo_cobro|intcomma }}</div>
                    </div>
                    {% if transaccion.medio_cobro == 'Efectivo' %}
                    <div class="detalle-item">
                        <div class="detalle-titulo">Redondeo por medio de cobro Efectivo:</div>
                        <div class="detalle-valor">Gs. {{ transaccion.redondeo_efectivo_precio_final|intcomma }}</div>
                    </div>
                    {% endif %}
                    <div class="detalle-item">
                        <div class="detalle-titulo" style="font-size:large">Monto a pagar:</div>
                        <div class="detalle-valor" style="font-size:large">{{ transaccion.monto|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-titulo" style="font-size:large">Monto a recibir:</div>
                        <div class="detalle-valor" style="font-size:large">Gs. {{ transaccion.precio_final|intcomma }}</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="post" id="confirmacionForm">
    {% csrf_token %}
        <div class="zona-botones">
            {% if enable_2fa %}
                {% if has_email %}
                    {% if transaccion.tipo == 'venta' %}
                        <button type="button" id="confirmarBtn" class="btn-enviar">
                            Confirmar Venta
                        </button>
                    {% else %}
                        <button type="button" id="confirmarBtn" class="btn-enviar">
                            Confirmar Compra
                        </button>
                    {% endif %}
                {% else %}
                    <div class="mensaje-advertencia" style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
                        <strong>⚠️ Email requerido:</strong> Necesitas tener un email registrado en tu cuenta para utilizar la verificación de seguridad. Contacta al administrador para actualizar tu perfil.
                    </div>
                    {% if transaccion.tipo == 'venta' %}
                        <button type="submit" name="accion" value="confirmar" class="btn-enviar" disabled>
                            Confirmar Venta (Email requerido)
                        </button>
                    {% else %}
                        <button type="submit" name="accion" value="confirmar" class="btn-enviar" disabled>
                            Confirmar Compra (Email requerido)
                        </button>
                    {% endif %}
                {% endif %}
            {% else %}
                {% if transaccion.tipo == 'venta' %}
                    <button type="submit" name="accion" value="confirmar" class="btn-enviar">
                        Confirmar Venta
                    </button>
                {% else %}
                    <button type="submit" name="accion" value="confirmar" class="btn-enviar">
                        Confirmar Compra
                    </button>
                {% endif %}
            {% endif %}
            <button type="submit" name="accion" value="cancelar" class="btn-atras">
                Cancelar {% if transaccion.tipo == 'venta' %}Venta{% else %}Compra{% endif %}
            </button>
        </div>
    </form>
    {% if cambios %}
    <div class="popup-overlay" style="display: flex">
        <div class="popup-contenido" style="max-width: 700px;">
            <div class="popup-cabecera">
                <h3>¡La cotización ha cambiado!</h3>
            </div>
            <div class="popup-cuerpo">
                {% if transaccion.tipo == 'compra' %}
                    <p>El precio de venta a cambiado de Gs. {{ cambios.valores_anteriores.precio_venta|intcomma }} a Gs. {{ cambios.valores_actuales.precio_venta|intcomma }}</p>
                {% else %}
                    <p>El precio de compra a cambiado de Gs. {{ cambios.valores_anteriores.precio_compra|intcomma }} a Gs. {{ cambios.valores_actuales.precio_compra|intcomma }}</p>
                {% endif %}
                <form method="post">
                {% csrf_token %}
                    <div class="zona-botones">
                        <button type="submit" name="action" value="aceptar" class="btn-enviar">
                            Aceptar Nuevo Precio
                        </button>
                        <button type="submit" name="action" value="cancelar" class="btn-atras">
                            Cancelar Operación
                        </button>
                    </div>
                </form>    
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modal 2FA -->
    {% if enable_2fa and has_email %}
    <div id="modal2FA" class="popup-overlay" style="display: none;">
        <div class="popup-contenido" style="max-width: 500px;">
            <div class="popup-cabecera">
                <h3>🔐 Verificación de Seguridad</h3>
            </div>
            <div class="popup-cuerpo">
                <div id="step-sending" class="verification-step">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Enviando código de verificación a <strong>{{ user_email }}</strong>...</p>
                    </div>
                </div>
                
                <div id="step-verify" class="verification-step" style="display: none;">
                    <p>Se ha enviado un código de verificación de 6 dígitos a tu email <strong>{{ user_email }}</strong></p>
                    <div class="input-group">
                        <label for="tokenInput">Código de verificación:</label>
                        <input type="text" id="tokenInput" maxlength="6" placeholder="123456" 
                               class="form-control" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;">
                        <small class="form-text text-muted">El código expira en <span id="timerDisplay">1:00</span></small>
                    </div>
                    <div id="tokenError" class="mensaje-error" style="display: none;"></div>
                    
                    <div class="zona-botones">
                        <button type="button" id="verificarBtn" class="btn-primario">
                            Verificar Código
                        </button>
                        <button type="button" id="reenviarBtn" class="btn-primario">
                            Reenviar Código
                        </button>
                    </div>
                    
                    <!-- Botón cancelar en sección separada -->
                    <div class="zona-botones" style="margin-top: 1rem;">
                        <button type="button" id="cancelar2FABtn" class="btn-atras">
                            Cancelar
                        </button>
                    </div>
                </div>
                
                <div id="step-error" class="verification-step" style="display: none;">
                    <div class="mensaje-error">
                        <p id="errorMessage">Error al enviar código de verificación</p>
                        <div class="zona-botones">
                            <button type="button" id="reintentar2FABtn" class="btn-enviar">
                                Reintentar
                            </button>
                            <button type="button" id="cancelarError2FABtn" class="btn-atras">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if enable_2fa and has_email %}
<style>
/* Estilos específicos para modal 2FA */
/* Botones deshabilitados en modal */
#modal2FA .btn-primario:disabled, 
#modal2FA .btn-enviar:disabled, 
#modal2FA .btn-atras:disabled {
    opacity: 0.6 !important;
    cursor: not-allowed !important;
    background: #d6d6d6 !important;
    color: #888888 !important;
    border: 1px solid #cccccc !important;
    box-shadow: none !important;
    transform: none !important;
}

#modal2FA .btn-primario:disabled:hover, 
#modal2FA .btn-enviar:disabled:hover, 
#modal2FA .btn-atras:disabled:hover {
    transform: none !important;
    box-shadow: none !important;
    background: #d6d6d6 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal2FA = document.getElementById('modal2FA');
    const confirmarBtn = document.getElementById('confirmarBtn');
    const tokenInput = document.getElementById('tokenInput');
    const verificarBtn = document.getElementById('verificarBtn');
    const reenviarBtn = document.getElementById('reenviarBtn');
    const cancelar2FABtn = document.getElementById('cancelar2FABtn');
    const reintentar2FABtn = document.getElementById('reintentar2FABtn');
    const cancelarError2FABtn = document.getElementById('cancelarError2FABtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const tokenError = document.getElementById('tokenError');
    const errorMessage = document.getElementById('errorMessage');
    
    let countdownTimer = null;
    let timeRemaining = 60; // 1 minuto
    
    // Función helper para manejar estados de botones
    function setButtonStates(reenviarEnabled, verificarEnabled) {
        reenviarBtn.disabled = !reenviarEnabled;
        verificarBtn.disabled = !verificarEnabled;
        console.log('Estados actualizados - Reenviar:', reenviarEnabled ? 'HABILITADO' : 'DESHABILITADO', 
                   'Verificar:', verificarEnabled ? 'HABILITADO' : 'DESHABILITADO');
    }
    
    // Función para mostrar pasos del modal
    function showStep(stepId) {
        document.querySelectorAll('.verification-step').forEach(step => {
            step.style.display = 'none';
        });
        document.getElementById(stepId).style.display = 'block';
    }
    
    // Función para iniciar countdown
    function startCountdown() {
        if (countdownTimer) clearInterval(countdownTimer);
        timeRemaining = 60;
        
        // Mantener texto fijo en el botón sin contador
        reenviarBtn.textContent = 'Reenviar Código';
        
        countdownTimer = setInterval(() => {
            timeRemaining--;
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            // No actualizar el texto del botón con el contador
            
            if (timeRemaining <= 0) {
                clearInterval(countdownTimer);
                timerDisplay.textContent = 'Expirado';
                showError('El código ha expirado. Solicita uno nuevo.');
                
                // Estado: Token expirado - Reenviar habilitado, Verificar deshabilitado
                setButtonStates(true, false);
                reenviarBtn.textContent = 'Reenviar Código';
                verificarBtn.textContent = 'Código Expirado';
            }
        }, 1000);
    }
    
    // Función para mostrar errores
    function showError(message) {
        tokenError.textContent = message;
        tokenError.style.display = 'block';
    }
    
    // Función para limpiar errores
    function clearError() {
        tokenError.style.display = 'none';
    }
    
    // Evento click en confirmar transacción
    confirmarBtn.addEventListener('click', function() {
        modal2FA.style.display = 'flex';
        showStep('step-sending');
        // Estado inicial: ambos botones deshabilitados mientras se envía el token
        setButtonStates(false, false);
        sendToken();
    });
    
    // Enviar token
    function sendToken() {
        clearError();
        
        fetch('{% url "transacciones:send_2fa_token" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStep('step-verify');
                // Estado: Token enviado - Verificar habilitado, Reenviar deshabilitado
                setButtonStates(false, true);
                reenviarBtn.textContent = 'Reenviar Código';
                verificarBtn.textContent = 'Verificar Código';
                startCountdown();
                tokenInput.focus();
            } else {
                showStep('step-error');
                errorMessage.textContent = data.message || 'Error al enviar código de verificación';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStep('step-error');
            errorMessage.textContent = 'Error de conexión. Intenta nuevamente.';
        });
    }
    
    // Verificar token
    function verifyToken() {
        const token = tokenInput.value.trim();
        
        if (!token) {
            showError('Ingresa el código de verificación');
            return;
        }
        
        if (token.length !== 6 || !/^\d{6}$/.test(token)) {
            showError('El código debe contener exactamente 6 dígitos');
            return;
        }
        
        clearError();
        verificarBtn.disabled = true;
        verificarBtn.textContent = 'Verificando...';
        
        fetch('{% url "transacciones:verify_2fa_token" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ token: token })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (countdownTimer) clearInterval(countdownTimer);
                modal2FA.style.display = 'none';
                
                // Redirigir o mostrar mensaje de éxito
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    // Fallback: enviar formulario tradicional
                    const form = document.getElementById('confirmacionForm');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'accion';
                    hiddenInput.value = 'confirmar';
                    form.appendChild(hiddenInput);
                    form.submit();
                }
            } else {
                showError(data.message || 'Código incorrecto');
                // Estado: Error en verificación - mantener verificar habilitado, reenviar según tiempo restante
                verificarBtn.disabled = false;
                verificarBtn.textContent = 'Verificar Código';
                tokenInput.select();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error de conexión. Intenta nuevamente.');
            // Estado: Error de conexión - mantener verificar habilitado
            verificarBtn.disabled = false;
            verificarBtn.textContent = 'Verificar Código';
        });
    }
    
    // Event listeners
    verificarBtn.addEventListener('click', verifyToken);
    
    // Permitir verificar con Enter
    tokenInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyToken();
        }
    });
    
    // Solo permitir números en el input
    tokenInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
        clearError();
    });
    
    // Reenviar código
    reenviarBtn.addEventListener('click', function() {
        if (countdownTimer) clearInterval(countdownTimer);
        showStep('step-sending');
        sendToken();
    });
    
    // Cancelar desde modal de verificación
    cancelar2FABtn.addEventListener('click', function() {
        if (countdownTimer) clearInterval(countdownTimer);
        modal2FA.style.display = 'none';
    });
    
    // Reintentar desde error
    reintentar2FABtn.addEventListener('click', function() {
        showStep('step-sending');
        sendToken();
    });
    
    // Cancelar desde error
    cancelarError2FABtn.addEventListener('click', function() {
        modal2FA.style.display = 'none';
    });
    
    // Cerrar modal con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal2FA.style.display === 'flex') {
            if (countdownTimer) clearInterval(countdownTimer);
            modal2FA.style.display = 'none';
        }
    });
});
</script>

<style>
.loading-container {
    text-align: center;
    padding: 2rem;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.input-group {
    margin: 1.5rem 0;
}

.input-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

/* Estilos específicos del formulario del modal */
#modal2FA .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

#modal2FA .form-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

/* Estilos específicos del modal 2FA - no están en archivos globales */
.mensaje-error {
    background-color: #f8d7da;
    color: #721c24;
    padding: 0.75rem;
    border-radius: 5px;
    border: 1px solid #f5c6cb;
    margin: 1rem 0;
}

.mensaje-advertencia {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
    color: #856404;
    padding: 1rem;
    margin-bottom: 1rem;
}
</style>
{% endif %}
{% endblock %}