{% extends 'base.html' %}
{% load static %}

{% block title %}Historial de Transacciones - Global Exchange{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'claro/gestion.css' %}" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="{% static 'oscuro/gestion.css' %}" media="(prefers-color-scheme: dark)">
{% endblock %}

{% block content %}
<div class="contenido">
    <div class="gestion-cabecera">
        <h2>
            {% if cliente_filtrado %}
                Historial de Transacciones - Cliente: {{ cliente_filtrado.nombre }}
            {% elif usuario_filtro %}
                Historial de Transacciones - Usuario
            {% else %}
                Historial de Transacciones
            {% endif %}
        </h2>
    </div>
    <!-- Formulario de búsqueda -->
    <div class="zona-busqueda">
        <form method="get" class="busqueda-form">
            {% if usuario_filtro %}
                <input type="hidden" name="usuario" value="{{ usuario_filtro }}">
            {% endif %}
            {% if cliente_filtrado and usuarios_cliente %}
            <div class="campo-filtro">
                <select name="usuario" class="select-filtro">
                    <option value="">Todos los usuarios del cliente</option>
                    {% for usuario in usuarios_cliente %}
                    <option value="{{ usuario.id }}" {% if usuario_filtro == usuario.id|stringformat:"s" %}selected{% endif %}>
                        {{ usuario.nombre_completo|default:usuario.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="campo-filtro">
                <select name="tipo_operacion" class="select-filtro">
                    <option value="">Todos los tipos</option>
                    <option value="compra" {% if tipo_operacion == 'compra' %}selected{% endif %}>
                        Compra
                    </option>
                    <option value="venta" {% if tipo_operacion == 'venta' %}selected{% endif %}>
                        Venta
                    </option>
                </select>
            </div>
            <div class="campo-filtro">
                <select name="estado" class="select-filtro">
                    <option value="">Todos los estados</option>
                    <option value="pendiente" {% if estado_filtro == 'Pendiente' %}selected{% endif %}>
                        Pendiente
                    </option>
                    <option value="confirmada" {% if estado_filtro == 'Confirmada' %}selected{% endif %}>
                        Confirmada
                    </option>
                     <option value="completa" {% if estado_filtro == 'Completa' %}selected{% endif %}>
                        Completa
                    </option>
                    <option value="cancelada" {% if estado_filtro == 'Cancelada' %}selected{% endif %}>
                        Cancelada
                    </option>
                    <option value="anulada" {% if estado_filtro == 'Anulada' %}selected{% endif %}>
                        Anulada
                    </option>
                </select>
            </div>
            <div class="botones-busqueda">
                <button type="submit" class="btn-buscar">
                    Buscar
                </button>
                {% if busqueda or tipo_operacion or estado_filtro or usuario_filtro %}
                <a href="{% if cliente_filtrado %}{% url 'transacciones:historial_cliente' cliente_filtrado.id %}{% elif usuario_filtro %}{% url 'transacciones:historial' %}?usuario={{ usuario_filtro }}{% else %}{% url 'transacciones:historial' %}{% endif %}" class="btn-limpiar">
                    Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="zona-conteo">
        <div class="conteo-info">
            Total de transacciones: <span class="conteo">{{ transacciones|length }}</span>
            {% if busqueda or tipo_operacion or estado_filtro or usuario_filtro %}
                <span style="margin-left: 1rem; color: #6c757d;">
                    ({{ transacciones|length }} resultado{{ transacciones|length|pluralize }}
                    {% if usuario_filtro and cliente_filtrado %}del usuario seleccionado{% elif usuario_filtro %}del usuario actual{% endif %}
                    {% if busqueda %}para "{{ busqueda }}"{% endif %}
                    {% if tipo_operacion %}de tipo {{ tipo_operacion|title }}{% endif %}
                    {% if estado_filtro %}en estado {{ estado_filtro|title }}{% endif %})
                </span>
            {% endif %}
        </div>
    </div>
    <table class="gestion-tabla">
        <thead>
            <tr>
                <th>Fecha/Hora</th>
                <th>Usuario</th>
                <th>Operación</th>
                <th>Origen</th>
                <th>Destino</th>
                <th style="min-width: 250px; max-width: 350px;">Medios</th>
                <th>Estado</th>
                <!--<th>Acciones</th>-->
            </tr>
        </thead>
        <tbody>
            {% for transaccion in transacciones %}
            <tr>
                <td>
                    <div>
                        <strong>{{ transaccion.fecha_hora|date:"d/m/Y" }}</strong><br>
                        <small>{{ transaccion.fecha_hora|time:"H:i:s" }}</small>
                    </div>
                </td>
                <td>
                    <div>
                        {{ transaccion.usuario.nombre_completo }}
                    </div>
                </td>
                <td>
                    <div class="tipo-operacion {% if transaccion.tipo == 'compra' %}compra{% else %}venta{% endif %}">
                        {{ transaccion.tipo|title }}
                    </div>
                </td>
                <td>
                    {% if transaccion.tipo == 'compra' %}
                        {{ transaccion.monto_origen|floatformat:0 }} PYG
                    {% else %}
                        {{ transaccion.monto_origen|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}
                    {% endif %}
                </td>
                <td>
                    {% if transaccion.tipo == 'compra' %}
                        {{ transaccion.monto_destino|floatformat:transaccion.moneda.decimales }} {{ transaccion.moneda.simbolo }}
                    {% else %}
                        {{ transaccion.monto_destino|floatformat:0 }} PYG
                    {% endif %}
                </td>
                <td style="min-width: 250px; max-width: 350px; white-space: normal; text-overflow: unset; overflow: visible; padding: 0.8rem 1rem; text-align: left;">
                    <div style="display: flex; flex-direction: column; gap: 0.4rem; line-height: 1.4;">
                        <div style="display: flex; align-items: flex-start; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-weight: 600; min-width: 45px; flex-shrink: 0; font-size: 0.85rem;">Pago:</span>
                            <span style="font-size: 0.85rem; word-break: break-word; flex: 1;">{{ transaccion.medio_pago_formateado }}</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-weight: 600; min-width: 45px; flex-shrink: 0; font-size: 0.85rem;">Cobro:</span>
                            <span style="font-size: 0.85rem; word-break: break-word; flex: 1;">{{ transaccion.medio_cobro }}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="estado-transaccion estado-{{ transaccion.estado|lower }}">
                        {{ transaccion.estado }}
                    </div>
                </td>
                
                <!--<td>
                    <div class="zona-acciones">
                        <a href="{% url 'transacciones:detalle' transaccion.pk %}" class="btn-detalles" title="Ver detalles">
                            Detalles
                        </a>
                    </div>
                </td>
            -->
                
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">
                    {% if busqueda or tipo_operacion or estado_filtro or usuario_filtro or cliente_filtrado %}
                        No se encontraron transacciones que coincidan con los filtros aplicados.
                    {% else %}
                        No hay transacciones registradas.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}