{% extends 'base.html' %}
{% load static %}

{% block title %}Gestionar Usuarios - Global Exchange{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gestion.css' %}">
{% endblock %}

{% block content %}
<div class="contenido">
    <div class="gestion-cabecera">
        <h2>Gestionar Usuarios</h2>
    </div>

    <div class="zona-busqueda">
        <form method="get" class="busqueda-form">
            <div class="campo-busqueda">
                <input type="text" 
                       name="busqueda" 
                       class="texto-busqueda" 
                       value="{{ busqueda }}" 
                       placeholder="Buscar por nombre, apellido o nombre de usuario">
            </div>
            <div class="botones-busqueda">
                <button type="submit" class="btn-buscar">
                    Buscar
                </button>
                {% if busqueda %}
                <a href="{% url 'usuarios:administrar_usuarios' %}" class="btn-limpiar">
                    Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="zona-conteo">
        <div class="conteo-info">
            <span>Total: <span class="conteo">{{ total_usuarios }}</span></span>
            <span style="margin-left: 1rem;">Activos: <span class="conteo" style="background: #28a745;">{{ usuarios_activos }}</span></span>
            <span style="margin-left: 0.5rem;">Bloqueados: <span class="conteo" style="background: #dc3545;">{{ usuarios_bloqueados }}</span></span>
        </div>
    </div>

    <table class="gestion-tabla">
        <thead>
            <tr>
                <th style="width: 15%">Nombre Completo</th>
                <th style="width: 12%">Usuario</th>
                <th style="width: 18%">Correo electrónico</th>
                <th style="width: 15%">Roles</th>
                <th style="width: 15%">Clientes Asignados</th>
                <th style="width: 10%">Estado</th>
                <th style="width: 15%">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td>{{ usuario.get_full_name }}</td>
                <td>{{ usuario.username }}</td>
                <td>{{ usuario.email }}</td>

                <td>
                    {% if usuario.groups.exists %}
                        {% for group in usuario.groups.all %}
                            <span class="etiqueta-rol {% if group.name == 'Administrador' %}rol-admin{% elif group.name == 'Analista cambiario' %}rol-analista{% elif group.name == 'Operador' %}rol-operador{% else %}rol-otro{% endif %}">
                                {{ group.name|title }}
                                {% if perms.usuarios.asignacion_roles %}
                                    <form style="display: inline;" method="post" action="{% url 'usuarios:remover_rol' usuario.pk group.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-remover-rol" 
                                                onclick="return confirm('¿Estás seguro de que deseas desasignar el rol {{ group.name }} de {{ usuario.get_full_name }}?')"
                                                title="Desasignar rol">×</button>
                                    </form>
                                {% endif %}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #6c757d; font-style: italic;">Sin roles</span>
                    {% endif %}
                </td>

                <td>
                    {% with clientes_count=usuario.clientes_operados.count %}
                        {% if clientes_count > 0 %}
                            <div class="cantidad-clientes">{{ clientes_count }} cliente{{ clientes_count|pluralize }}</div>
                            <br>
                            {% if perms.usuarios.asignacion_clientes %}
                                <a href="{% url 'usuarios:ver_clientes_usuario' usuario.pk %}" class="btn-clientes">
                                    Ver Clientes
                                </a>
                            {% else %}
                                <span style="color: #6c757d; font-size: 0.75rem;">{{ clientes_count }} cliente{{ clientes_count|pluralize }}</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #6c757d; font-style: italic;">Sin clientes</span>
                            {% if perms.usuarios.asignacion_clientes %}
                                <br>
                                <a href="{% url 'usuarios:asignar_clientes' usuario.pk %}" class="btn-clientes">
                                    Asignar
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <span class="{% if not usuario.bloqueado %}etiqueta-activo{% else %}etiqueta-inactivo{% endif %}">
                        {% if not usuario.bloqueado %}Activo{% else %}Bloqueado{% endif %}
                    </span>
                </td>
                <td>
                    <div class="zona-acciones">
                        {% if perms.usuarios.asignacion_roles %}
                            <a href="{% url 'usuarios:asignar_rol' usuario.pk %}" class="btn-rol">
                                Asignar Rol
                            </a>
                        {% endif %}

                        {% if perms.usuarios.bloqueo %}
                            <form action="{% url 'usuarios:bloquear_usuario' usuario.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                {% if not usuario.bloqueado %}
                                    <button type="submit" class="btn-desactivar"
                                            title="Bloquear usuario"
                                            onclick="return confirm('¿Estás seguro de que deseas bloquear al usuario {{ usuario.get_full_name }}?')">
                                        Bloquear
                                    </button>
                                {% else %}
                                    <button type="submit" class="btn-activar"
                                            title="Desbloquear usuario"
                                            onclick="return confirm('¿Estás seguro de que deseas desbloquear al usuario {{ usuario.get_full_name }}?')">
                                        Desbloquear
                                    </button>
                                {% endif %}
                            </form>
                        {% endif %}

                        {% if not perms.usuarios.bloqueo and not perms.usuarios.asignacion_roles %}
                            <span style="color: #6c757d; font-style: italic; font-size: 0.8rem;">Sin permisos</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">
                    {% if busqueda %}
                        No se encontraron usuarios que coincidan con "{{ busqueda }}".
                    {% else %}
                        No hay otros usuarios registrados.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}